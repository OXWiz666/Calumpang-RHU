import{u as R,r as z,j as e}from"./app-CZwS2G5Y.js";import{r as v}from"./vendor-DkBadjUr.js";import{B as d}from"./button-BesobgtA.js";import{I as j}from"./input-BuSGIsg0.js";import{L as o}from"./label-IliVNXtj.js";import{T as O}from"./textarea-B339UmIC.js";import{C as S,a as B,b as L,c as D}from"./card-CRUoSCLq.js";import{S as Q,a as J,b as U,c as V,d as M}from"./select-Cxat1dCU.js";import{X as H}from"./x-b8JahagL.js";import{R as W}from"./refresh-cw-D3hZ7e_O.js";import{P as X}from"./plus-MavOGQlj.js";import{T as k}from"./trash-2-DJ5zXW8D.js";import{F as G}from"./file-text-YZXa1D2L.js";import{P as K}from"./printer-CfgcPaUh.js";import"./pusher-DVtoYAOu.js";import"./index-B3OEEYC6.js";import"./react-icons.esm-Bo4nchVy.js";import"./index-BL_R5CeI.js";import"./index-DWou3t1m.js";import"./index-VaCZcEHj.js";import"./tslib.es6-M_FJ09fS.js";import"./index-hcl4Lfqn.js";import"./index-Dg-CcdeN.js";import"./index-DqxisvwK.js";import"./index-C0yHodGM.js";import"./createLucideIcon-BKWaAi2G.js";function Ce({patient:m,doctors:c,medicines:u,onSubmit:I,onCancel:_,errors:p={}}){const{data:a,setData:f,post:Y,processing:b,reset:F}=R({patient_id:m?.id||"",doctor_id:c&&c.length>0?c[0].user_id:"",prescription_date:new Date().toISOString().split("T")[0],case_id:"",medicines:[{medicine_id:"",frequency:"",duration:"",quantity:"",instructions:""}]}),[h,P]=v.useState([]),[N,w]=v.useState(!1);v.useEffect(()=>{console.log("Medicines prop received:",u),console.log("Medicines type:",typeof u),console.log("Medicines length:",u?u.length:"undefined"),u?P(u):console.log("No medicines prop received");const i=localStorage.getItem("prescription_draft");if(i)try{const t=JSON.parse(i);t.patient_id===m?.id&&(f(t),console.log("Loaded prescription draft"))}catch(t){console.error("Error loading draft:",t)}},[u,m?.id]),v.useEffect(()=>{if(window.Echo)return window.Echo.channel("inventory-updates").listen("InventoryUpdated",i=>{console.log("Inventory updated, refreshing medicines...",i),C()}),()=>{window.Echo.leaveChannel("inventory-updates")}},[]);const C=()=>{w(!0),z.reload({only:["medicines"],onFinish:()=>{w(!1)}})},E=()=>{f("medicines",[...a.medicines,{medicine_id:"",frequency:"",duration:"",quantity:"",instructions:""}])},T=i=>{const t=a.medicines.filter((s,n)=>n!==i);f("medicines",t)},x=(i,t,s)=>{const n=[...a.medicines];if(n[i][t]=s,t==="medicine_id"&&s){const l=h.find(r=>r.id==s);l&&(n[i].medicine_name=l.name,n[i].available_stock=l.available_quantity,n[i].unit=l.unit)}f("medicines",n)},g=(i,t)=>a.medicines.some((s,n)=>n!==t&&s.medicine_id===i),$=(i,t)=>{const s=h.find(n=>n.id==i);return s&&parseInt(t)>s.available_quantity?`Only ${s.available_quantity} ${s.unit} available`:null},A=i=>{i.preventDefault();let t=!1;const s={},n=a.medicines.filter(r=>r.medicine_id&&r.dosage&&r.frequency&&r.duration&&r.quantity);if(n.length===0){alert("Please add at least one medicine to the prescription.");return}if(a.medicines.forEach((r,y)=>{if(r.medicine_id&&(g(r.medicine_id,y)&&(s[`medicine_${y}_duplicate`]="This medicine is already added to the prescription.",t=!0),r.quantity)){const q=$(r.medicine_id,r.quantity);q&&(s[`medicine_${y}_stock`]=q,t=!0)}}),t){const r=Object.values(s)[0];alert(r);return}const l={...a,medicines:n};localStorage.removeItem("prescription_draft"),I(l)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs(S,{className:"w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(L,{children:["Add Prescription for ",m?.firstname," ",m?.lastname]}),e.jsx(d,{variant:"ghost",size:"sm",onClick:_,children:e.jsx(H,{className:"h-4 w-4"})})]})}),e.jsx(D,{children:e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"doctor_id",children:"Doctor *"}),e.jsx("div",{className:"mt-1 p-3 bg-gray-50 border rounded-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:c&&c.length>0?`${c[0].user.firstname} ${c[0].user.lastname}`:"No doctor available"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID: ",c&&c.length>0?c[0].user_id:"N/A"]})]}),e.jsx("div",{className:"text-green-600",children:e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})})]})}),p.doctor_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.doctor_id})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"prescription_date",children:"Prescription Date *"}),e.jsx(j,{id:"prescription_date",type:"date",value:a.prescription_date,onChange:i=>f("prescription_date",i.target.value),className:"mt-1",max:new Date().toISOString().split("T")[0]}),p.prescription_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.prescription_date})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"case_id",children:"Case ID *"}),e.jsx(j,{id:"case_id",type:"text",value:a.case_id,onChange:i=>f("case_id",i.target.value),placeholder:"e.g., CASE-001, MED-2025-001, etc.",className:"mt-1"}),p.case_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.case_id})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{children:"Medicines *"}),N&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{type:"button",onClick:C,variant:"outline",size:"sm",disabled:N,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(d,{type:"button",onClick:E,size:"sm",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Add Medicine"]})]})]}),e.jsx("div",{className:"space-y-4",children:a.medicines.map((i,t)=>e.jsx(S,{children:e.jsxs(D,{className:"pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium",children:["Medicine ",t+1]}),a.medicines.length>1&&e.jsx(d,{type:"button",variant:"ghost",size:"sm",onClick:()=>T(t),children:e.jsx(k,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:`medicine_${t}`,children:"Medicine *"}),e.jsxs(Q,{value:i.medicine_id,onValueChange:s=>x(t,"medicine_id",s),children:[e.jsx(J,{className:"mt-1",children:e.jsx(U,{placeholder:"Select Medicine"})}),e.jsx(V,{children:h&&h.length>0?h.map(s=>e.jsxs(M,{value:String(s.id),disabled:g(s.id,t),children:[s.name," (",s.generic_name,") - Batch: ",s.batch_number," - Stock: ",s.available_quantity," ",s.unit,g(s.id,t)&&" (Already added)"]},s.id)):e.jsx(M,{value:"no-medicines",disabled:!0,children:"No medicines available"})})]}),i.medicine_id&&g(i.medicine_id,t)&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:"This medicine is already added to the prescription."})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:`frequency_${t}`,children:"Frequency *"}),e.jsx(j,{id:`frequency_${t}`,value:i.frequency,onChange:s=>x(t,"frequency",s.target.value),placeholder:"e.g., 3 times daily",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:`duration_${t}`,children:"Duration *"}),e.jsx(j,{id:`duration_${t}`,value:i.duration,onChange:s=>x(t,"duration",s.target.value),placeholder:"e.g., 7 days",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:`quantity_${t}`,children:"Quantity *"}),e.jsx(j,{id:`quantity_${t}`,type:"number",min:"1",max:i.available_stock||999999,value:i.quantity,onChange:s=>x(t,"quantity",s.target.value),placeholder:"e.g., 30",className:"mt-1"}),i.quantity&&i.medicine_id&&(()=>{const s=$(i.medicine_id,i.quantity);return s?e.jsx("p",{className:"text-sm text-red-600 mt-1",children:s}):e.jsxs("p",{className:"text-sm text-green-600 mt-1",children:["Available: ",i.available_stock," ",i.unit]})})()]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(o,{htmlFor:`instructions_${t}`,children:"Instructions"}),e.jsx(O,{id:`instructions_${t}`,value:i.instructions,onChange:s=>x(t,"instructions",s.target.value),placeholder:"Special instructions for this medicine",className:"mt-1",rows:2})]})]})]})},t))})]}),a.medicines.some(i=>i.medicine_id)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Prescription Summary"}),e.jsx("div",{className:"space-y-2",children:a.medicines.filter(i=>i.medicine_id).map((i,t)=>{const s=h.find(n=>n.id==i.medicine_id);return e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{children:[s?.name," - ",i.dosage," - ",i.frequency," - ",i.duration]}),e.jsxs("span",{className:"font-medium",children:["Qty: ",i.quantity," ",s?.unit]})]},t)})}),e.jsx("div",{className:"mt-3 pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Total Medicines:"}),e.jsx("span",{children:a.medicines.filter(i=>i.medicine_id).length})]})})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(d,{type:"button",variant:"outline",onClick:()=>{confirm("Are you sure you want to clear all form data?")&&F()},children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Clear Form"]}),e.jsxs(d,{type:"button",variant:"outline",onClick:()=>{const i={...a,medicines:a.medicines.filter(t=>t.medicine_id)};localStorage.setItem("prescription_draft",JSON.stringify(i)),alert("Prescription saved as draft!")},children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Save as Draft"]}),e.jsxs(d,{type:"button",variant:"outline",onClick:()=>{const i=window.open("","_blank"),t=a.medicines.filter(n=>n.medicine_id),s=c&&c.length>0?c[0]:null;i.document.write(`
                                            <html>
                                                <head><title>Prescription Preview</title></head>
                                                <body style="font-family: Arial, sans-serif; padding: 20px;">
                                                    <h2>Prescription for ${m?.firstname} ${m?.lastname}</h2>
                                                    <p><strong>Doctor:</strong> ${s?.user?s.user.firstname+" "+s.user.lastname:"Not selected"}</p>
                                                    <p><strong>Date:</strong> ${a.prescription_date}</p>
                                                    <p><strong>Case ID:</strong> ${a.case_id||"Not selected"}</p>
                                                    <hr>
                                                    <h3>Medicines:</h3>
                                                    ${t.map(n=>{const l=h.find(r=>r.id==n.medicine_id);return`
                                                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                                                                <strong>${l?.name||"Unknown"}</strong><br>
                                                                Dosage: ${n.dosage}<br>
                                                                Frequency: ${n.frequency}<br>
                                                                Duration: ${n.duration}<br>
                                                                Quantity: ${n.quantity} ${l?.unit||""}<br>
                                                                ${n.instructions?`Instructions: ${n.instructions}`:""}
                                                            </div>
                                                        `}).join("")}
                                                </body>
                                            </html>
                                        `),i.document.close(),i.print()},children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Print Preview"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(d,{type:"button",variant:"outline",onClick:_,children:"Cancel"}),e.jsx(d,{type:"submit",disabled:b,children:b?"Creating...":"Create Prescription"})]})]})]})})]})})}export{Ce as default};
