import{r as u,P as W,j as e,b as z}from"./app-B9imbgwF.js";import{D as G,a as K,b as Y,c as Z,d as ee}from"./dialog-DPtsGNkJ.js";import{B as S}from"./button-Cp6C2OJZ.js";import{I}from"./input-DrzP4N1f.js";import{L as m}from"./label-1pz5fh5X.js";import{T as se}from"./textarea-D1CoOFw3.js";import{S as D,a as w,b as q,c as C,d as B}from"./select-DLnb01nw.js";import{T}from"./trash-2-Co04Ehrd.js";import{m as k}from"./proxy-YO7Y0R0s.js";import{H as ae}from"./hash-wGhHJ59p.js";import{C as te}from"./calendar-BRhaHUHQ.js";import{C as ie}from"./circle-x-BTBBf5Nx.js";import{T as le}from"./triangle-alert-DVKExemm.js";import{C as re}from"./circle-check-big-Ben6InUX.js";import"./Combination-BvFtu0HL.js";import"./index-CPfQda0F.js";import"./utils-D5ZoOHm5.js";import"./index-DXqKCwml.js";import"./index-CPs_XpmV.js";import"./index-DBYg8BeE.js";import"./index-Dm9R2YI4.js";import"./index-DBY2uWYu.js";import"./createLucideIcon-CiaC_9KA.js";const Ae=({open:f,onClose:y,item:r,multi:d=!1,itemsForMulti:v=[]})=>{const[A,b]=u.useState([]),[x,N]=u.useState(null),[n,j]=u.useState([]),[p,E]=u.useState([]),[o,h]=u.useState({}),[O,P]=u.useState(""),{data:l,setData:c,post:$,processing:_}=W({item_id:r?.id||"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:"",disposed_by:"",notes:"",disposal_cost:"",batches:[]});u.useEffect(()=>{(async()=>{if(f){if(d){if(!p||p.length===0){b([]);return}try{const a=await(await fetch(route("pharmacist.inventory.items.batches"),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({item_ids:p.map(i=>i.id)})})).json();b(Array.isArray(a)?a:[])}catch(t){console.error("Failed to load batches",t),b([])}c({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:new Date().toISOString().split("T")[0],disposed_by:"Current User",notes:"",disposal_cost:""});return}if(r){try{const a=await(await fetch(route("pharmacist.inventory.item.batches",r.id))).json();b(Array.isArray(a)?a:[])}catch(t){console.error("Failed to load batches",t),b([])}c({item_id:r.id,batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:new Date().toISOString().split("T")[0],disposed_by:"Current User",notes:"",disposal_cost:""})}}})()},[r,f,d,JSON.stringify(p)]);const R=s=>{h({}),N(s),c({...l,batch_number:s.batch_number,quantity:s.available_quantity}),j(t=>t.find(i=>i.batch_number===s.batch_number)?t.filter(i=>i.batch_number!==s.batch_number):[...t,{...s,quantity:Math.min(s.available_quantity,s.quantity??s.available_quantity)}])},M=(s,t,a)=>{j(i=>i.map(g=>(g.item_id||l.item_id)===s&&g.batch_number===t?{...g,quantity:a}:g))},F=()=>{const s={};return n.length===0&&(s.batch_number="Please select at least one batch"),(Array.isArray(n)?n.reduce((a,i)=>a+(Number(i?.quantity)||0),0):0)<=0&&(s.quantity="Please enter a valid quantity for selected batches"),l.disposal_reason.trim()||(s.disposal_reason="Please provide a reason for disposal"),l.disposal_method||(s.disposal_method="Please select a disposal method"),l.disposal_date||(s.disposal_date="Please select a disposal date"),h(s),Object.keys(s).length===0},Q=s=>{if(s.preventDefault(),!F())return;if(!d&&x&&l.quantity>x.available_quantity){h({quantity:`Cannot dispose more than available stock (${x.available_quantity} units)`});return}if(l.disposal_date&&new Date(l.disposal_date)<new Date(new Date().toDateString())){h({disposal_date:"Disposal date cannot be in the past"});return}const t={item_id:l.item_id,batches:n.map(a=>({batch_number:a.batch_number,quantity:Number(a.quantity)||0})),disposal_reason:l.disposal_reason,disposal_method:l.disposal_method,disposal_date:l.disposal_date,disposed_by:l.disposed_by,notes:l.notes,disposal_cost:l.disposal_cost};if(n.length>1){console.log("Submitting bulk disposal with payload:",t),console.log("Selected batches:",n),z.post(route("pharmacist.inventory.dispose.bulk"),t,{onSuccess:()=>{console.log("Bulk disposal successful"),y(),c({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:"",disposed_by:"",notes:"",disposal_cost:"",batches:[]}),N(null),j([]),h({}),window.location.reload()},onError:a=>{console.error("Bulk disposal error:",a),h(a)}});return}$(route("pharmacist.inventory.dispose"),{onSuccess:()=>{y(),c({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:"",disposed_by:"",notes:"",disposal_cost:"",batches:[]}),N(null),j([]),h({}),window.location.reload()},onError:a=>{console.error("Disposal error:",a)}})},V=s=>s?new Date(s).toLocaleDateString():"N/A",L=s=>s?new Date(s)<new Date:!1,H=s=>{if(!s)return!1;const t=new Date(s),i=Math.ceil((t-new Date)/(1e3*60*60*24));return i<=30&&i>0},U=s=>L(s)?{status:"expired",color:"text-red-600",bgColor:"bg-red-50",icon:e.jsx(ie,{className:"h-4 w-4"})}:H(s)?{status:"expiring",color:"text-amber-600",bgColor:"bg-amber-50",icon:e.jsx(le,{className:"h-4 w-4"})}:{status:"valid",color:"text-green-600",bgColor:"bg-green-50",icon:e.jsx(re,{className:"h-4 w-4"})},X=[{value:"incineration",label:"Incineration"},{value:"landfill",label:"Landfill Disposal"},{value:"return_supplier",label:"Return to Supplier"},{value:"donation",label:"Donation (if applicable)"},{value:"other",label:"Other"}],J=[{value:"Expired",label:"Expired Product"},{value:"Damaged",label:"Damaged Product"},{value:"Recalled",label:"Product Recall"},{value:"Contaminated",label:"Contaminated Product"},{value:"Excess Stock",label:"Excess Stock"},{value:"Other",label:"Other"}];return!r&&!d?null:e.jsx(G,{open:f,onOpenChange:y,children:e.jsxs(K,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Y,{children:e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5 text-red-600"}),d?"Batch Disposal - Multiple Items":`Batch Disposal - ${r?.name??""}`]})}),e.jsxs("form",{onSubmit:Q,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Item Information"}),!d&&r&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.manufacturer||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.category?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Stock:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[r.quantity||0," ",r.unit_type||"units"]})]})]}),d&&e.jsxs("div",{children:[e.jsx(m,{className:"text-sm font-medium",children:"Select Batch Numbers"}),e.jsx("div",{className:"mt-2",children:e.jsxs(D,{value:O,onValueChange:s=>{P(s);const t=parseInt(s,10),a=v.find(i=>i.id===t);a&&!p.find(i=>i.id===t)&&E(i=>[...i,{id:a.id,batch_number:a.batch_number}])},children:[e.jsx(w,{children:e.jsx(q,{placeholder:"Choose expired batch to add"})}),e.jsx(C,{children:v.filter(s=>{const t=s.expiry_date||s.expiryDate;return t?new Date(t)<new Date:!1}).map(s=>e.jsx(B,{value:String(s.id),children:(s.batch_number||"")+(s.name?` (${s.name})`:"")},s.id))})]})}),p.length>0&&e.jsx("div",{className:"mt-3 flex flex-wrap gap-2",children:p.map(s=>{const t=v.find(a=>a.id===s.id);return e.jsxs("span",{className:"text-xs bg-gray-100 border rounded px-2 py-1 flex items-center gap-2",children:[(t?.batch_number||"")+(t?.name?` (${t?.name})`:""),e.jsx("button",{type:"button",className:"text-gray-500 hover:text-gray-700",onClick:()=>E(a=>a.filter(i=>i.id!==s.id)),children:"Ã—"})]},s.id)})}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Batches across selected items are listed below."})]})]}),e.jsxs("div",{children:[e.jsx(m,{className:"text-sm font-medium",children:"Available Batches"}),e.jsx("div",{className:"mt-2 space-y-2",children:(Array.isArray(A)?A:[]).map((s,t)=>{const a=U(s.expiry_date);return e.jsxs(k.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:t*.1},className:`p-3 border rounded-lg cursor-pointer transition-all ${n.find(i=>i.batch_number===s.batch_number)?"border-red-500 bg-red-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>R(s),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n.find(i=>i.batch_number===s.batch_number)?"bg-red-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{className:"font-medium",children:[s.batch_number,s.item_name?` (${s.item_name})`:""]}),e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded-full text-xs ${a.bgColor} ${a.color}`,children:[a.icon,a.status==="expired"?"Expired":a.status==="expiring"?"Expiring Soon":"Valid"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Available: ",s.available_quantity," units"]})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),V(s.expiry_date)]}),e.jsx("div",{className:"text-xs text-gray-500",children:s.location})]})]}),n.find(i=>i.batch_number===s.batch_number)&&e.jsxs("div",{className:"mt-3 pl-7",children:[e.jsx(m,{className:"text-xs",children:"Quantity to dispose for this batch"}),e.jsx(I,{type:"number",min:0,max:s.available_quantity,value:n.find(i=>i.batch_number===s.batch_number)?.quantity||0,onChange:i=>M(s.item_id||l.item_id,s.batch_number,Math.min(Number(i.target.value)||0,s.available_quantity)),className:"mt-1 w-40"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Max ",s.available_quantity]})]})]},`${s.item_id||l.item_id}:${s.batch_number||"NB"}:${t}`)})}),o.batch_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.batch_number})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{children:"Total Quantity to Dispose"}),e.jsxs("div",{className:"mt-1 font-medium",children:[n.reduce((s,t)=>s+(Number(t.quantity)||0),0)," units"]}),o.quantity&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.quantity})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"disposal_date",children:"Disposal Date *"}),e.jsx(I,{id:"disposal_date",type:"date",value:l.disposal_date,onChange:s=>c({...l,disposal_date:s.target.value}),className:"mt-1"}),o.disposal_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.disposal_date})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(m,{htmlFor:"disposal_reason",children:"Disposal Reason *"}),e.jsxs(D,{value:l.disposal_reason,onValueChange:s=>c({...l,disposal_reason:s}),children:[e.jsx(w,{className:"mt-1",children:e.jsx(q,{placeholder:"Select reason"})}),e.jsx(C,{children:J.map(s=>e.jsx(B,{value:s.value,children:s.label},s.value))})]}),o.disposal_reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.disposal_reason})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"disposal_method",children:"Disposal Method *"}),e.jsxs(D,{value:l.disposal_method,onValueChange:s=>c({...l,disposal_method:s}),children:[e.jsx(w,{className:"mt-1",children:e.jsx(q,{placeholder:"Select method"})}),e.jsx(C,{children:X.map(s=>e.jsx(B,{value:s.value,children:s.label},s.value))})]}),o.disposal_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:o.disposal_method})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"notes",children:"Additional Notes"}),e.jsx(se,{id:"notes",value:l.notes,onChange:s=>c({...l,notes:s.target.value}),placeholder:"Any additional notes about the disposal...",className:"mt-1",rows:3})]}),x&&l.quantity&&e.jsxs(k.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-semibold text-red-900 mb-2 flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),"Disposal Summary"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Batch:"}),e.jsx("span",{className:"ml-2 font-medium",children:x.batch_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Quantity:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[l.quantity," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Reason:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.disposal_reason||"Not specified"})]})]})]}),e.jsxs(ee,{children:[e.jsx(S,{type:"button",variant:"outline",onClick:y,disabled:_,children:"Cancel"}),!d&&e.jsx(S,{type:"submit",disabled:_||!x,className:"bg-red-600 hover:bg-red-700 text-white",children:_?"Disposing...":"Dispose Batch"}),d&&e.jsx(S,{type:"submit",disabled:_||n.length===0,className:"bg-red-600 hover:bg-red-700 text-white",children:_?"Disposing...":"Dispose Selected Batches"})]})]})]})})};export{Ae as default};
