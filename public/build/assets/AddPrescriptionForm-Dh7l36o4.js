import{u as R,r as z,j as e}from"./app-Dq_Q3Qwg.js";import{r as v}from"./vendor-DkBadjUr.js";import{B as o}from"./button-C5uFo_s4.js";import{I as j}from"./input-onBXUy1Y.js";import{L as l}from"./label-D-GXHI76.js";import{T as O}from"./textarea-C9hsFzqx.js";import{C as S,a as B,b as L,c as D}from"./card-kiyN5UMh.js";import{S as Q,a as J,b as U,c as V,d as M}from"./select-DVTvZC0C.js";import{X as H}from"./x-b8JahagL.js";import{R as W}from"./refresh-cw-D3hZ7e_O.js";import{P as X}from"./plus-MavOGQlj.js";import{T as k}from"./trash-2-DJ5zXW8D.js";import{F as G}from"./file-text-YZXa1D2L.js";import{P as K}from"./printer-CfgcPaUh.js";import"./pusher-DVtoYAOu.js";import"./index-Cwj52g8w.js";import"./react-icons.esm-B4fS-S41.js";import"./index-DWmZ7jWL.js";import"./index-DZ3-Nn1l.js";import"./index-BLzoH2V5.js";import"./tslib.es6-M_FJ09fS.js";import"./index-Z1kVBYZG.js";import"./index-BZWX2-NB.js";import"./index-DqxisvwK.js";import"./index-Bjz1F0Gi.js";import"./createLucideIcon-BKWaAi2G.js";function Ce({patient:m,doctors:c,medicines:u,onSubmit:F,onCancel:_,errors:p={}}){const{data:n,setData:f,post:Y,processing:b,reset:I}=R({patient_id:m?.id||"",doctor_id:c&&c.length>0?c[0].user_id:"",prescription_date:new Date().toISOString().split("T")[0],case_id:"",medicines:[{medicine_id:"",dosage:"",frequency:"",duration:"",quantity:"",instructions:""}]}),[h,P]=v.useState([]),[N,w]=v.useState(!1);v.useEffect(()=>{console.log("Medicines prop received:",u),console.log("Medicines type:",typeof u),console.log("Medicines length:",u?u.length:"undefined"),u?P(u):console.log("No medicines prop received");const i=localStorage.getItem("prescription_draft");if(i)try{const s=JSON.parse(i);s.patient_id===m?.id&&(f(s),console.log("Loaded prescription draft"))}catch(s){console.error("Error loading draft:",s)}},[u,m?.id]),v.useEffect(()=>{if(window.Echo)return window.Echo.channel("inventory-updates").listen("InventoryUpdated",i=>{console.log("Inventory updated, refreshing medicines...",i),C()}),()=>{window.Echo.leaveChannel("inventory-updates")}},[]);const C=()=>{w(!0),z.reload({only:["medicines"],onFinish:()=>{w(!1)}})},E=()=>{f("medicines",[...n.medicines,{medicine_id:"",dosage:"",frequency:"",duration:"",quantity:"",instructions:""}])},T=i=>{const s=n.medicines.filter((t,a)=>a!==i);f("medicines",s)},x=(i,s,t)=>{const a=[...n.medicines];if(a[i][s]=t,s==="medicine_id"&&t){const d=h.find(r=>r.id==t);d&&(a[i].medicine_name=d.name,a[i].available_stock=d.available_quantity,a[i].unit=d.unit)}f("medicines",a)},g=(i,s)=>n.medicines.some((t,a)=>a!==s&&t.medicine_id===i),$=(i,s)=>{const t=h.find(a=>a.id==i);return t&&parseInt(s)>t.available_quantity?`Only ${t.available_quantity} ${t.unit} available`:null},A=i=>{i.preventDefault();let s=!1;const t={},a=n.medicines.filter(r=>r.medicine_id&&r.dosage&&r.frequency&&r.duration&&r.quantity);if(a.length===0){alert("Please add at least one medicine to the prescription.");return}if(n.medicines.forEach((r,y)=>{if(r.medicine_id&&(g(r.medicine_id,y)&&(t[`medicine_${y}_duplicate`]="This medicine is already added to the prescription.",s=!0),r.quantity)){const q=$(r.medicine_id,r.quantity);q&&(t[`medicine_${y}_stock`]=q,s=!0)}}),s){const r=Object.values(t)[0];alert(r);return}const d={...n,medicines:a};localStorage.removeItem("prescription_draft"),F(d)};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs(S,{className:"w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(L,{children:["Add Prescription for ",m?.firstname," ",m?.lastname]}),e.jsx(o,{variant:"ghost",size:"sm",onClick:_,children:e.jsx(H,{className:"h-4 w-4"})})]})}),e.jsx(D,{children:e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:"doctor_id",children:"Doctor *"}),e.jsx("div",{className:"mt-1 p-3 bg-gray-50 border rounded-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:c&&c.length>0?`${c[0].user.firstname} ${c[0].user.lastname}`:"No doctor available"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID: ",c&&c.length>0?c[0].user_id:"N/A"]})]}),e.jsx("div",{className:"text-green-600",children:e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})})]})}),p.doctor_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.doctor_id})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"prescription_date",children:"Prescription Date *"}),e.jsx(j,{id:"prescription_date",type:"date",value:n.prescription_date,onChange:i=>f("prescription_date",i.target.value),className:"mt-1",max:new Date().toISOString().split("T")[0]}),p.prescription_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.prescription_date})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"case_id",children:"Case ID *"}),e.jsx(j,{id:"case_id",type:"text",value:n.case_id,onChange:i=>f("case_id",i.target.value),placeholder:"e.g., CASE-001, MED-2025-001, etc.",className:"mt-1"}),p.case_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:p.case_id})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{children:"Medicines *"}),N&&e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{type:"button",onClick:C,variant:"outline",size:"sm",disabled:N,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(o,{type:"button",onClick:E,size:"sm",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Add Medicine"]})]})]}),e.jsx("div",{className:"space-y-4",children:n.medicines.map((i,s)=>e.jsx(S,{children:e.jsxs(D,{className:"pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h4",{className:"font-medium",children:["Medicine ",s+1]}),n.medicines.length>1&&e.jsx(o,{type:"button",variant:"ghost",size:"sm",onClick:()=>T(s),children:e.jsx(k,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:`medicine_${s}`,children:"Medicine *"}),e.jsxs(Q,{value:i.medicine_id,onValueChange:t=>x(s,"medicine_id",t),children:[e.jsx(J,{className:"mt-1",children:e.jsx(U,{placeholder:"Select Medicine"})}),e.jsx(V,{children:h&&h.length>0?h.map(t=>e.jsxs(M,{value:String(t.id),disabled:g(t.id,s),children:[t.name," (",t.generic_name,") - Batch: ",t.batch_number," - Stock: ",t.available_quantity," ",t.unit,g(t.id,s)&&" (Already added)"]},t.id)):e.jsx(M,{value:"no-medicines",disabled:!0,children:"No medicines available"})})]}),i.medicine_id&&g(i.medicine_id,s)&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:"This medicine is already added to the prescription."})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:`dosage_${s}`,children:"Dosage *"}),e.jsx(j,{id:`dosage_${s}`,value:i.dosage,onChange:t=>x(s,"dosage",t.target.value),placeholder:"e.g., 500mg",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:`frequency_${s}`,children:"Frequency *"}),e.jsx(j,{id:`frequency_${s}`,value:i.frequency,onChange:t=>x(s,"frequency",t.target.value),placeholder:"e.g., 3 times daily",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:`duration_${s}`,children:"Duration *"}),e.jsx(j,{id:`duration_${s}`,value:i.duration,onChange:t=>x(s,"duration",t.target.value),placeholder:"e.g., 7 days",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:`quantity_${s}`,children:"Quantity *"}),e.jsx(j,{id:`quantity_${s}`,type:"number",min:"1",max:i.available_stock||999999,value:i.quantity,onChange:t=>x(s,"quantity",t.target.value),placeholder:"e.g., 30",className:"mt-1"}),i.quantity&&i.medicine_id&&(()=>{const t=$(i.medicine_id,i.quantity);return t?e.jsx("p",{className:"text-sm text-red-600 mt-1",children:t}):e.jsxs("p",{className:"text-sm text-green-600 mt-1",children:["Available: ",i.available_stock," ",i.unit]})})()]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(l,{htmlFor:`instructions_${s}`,children:"Instructions"}),e.jsx(O,{id:`instructions_${s}`,value:i.instructions,onChange:t=>x(s,"instructions",t.target.value),placeholder:"Special instructions for this medicine",className:"mt-1",rows:2})]})]})]})},s))})]}),n.medicines.some(i=>i.medicine_id)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-3",children:"Prescription Summary"}),e.jsx("div",{className:"space-y-2",children:n.medicines.filter(i=>i.medicine_id).map((i,s)=>{const t=h.find(a=>a.id==i.medicine_id);return e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{children:[t?.name," - ",i.dosage," - ",i.frequency," - ",i.duration]}),e.jsxs("span",{className:"font-medium",children:["Qty: ",i.quantity," ",t?.unit]})]},s)})}),e.jsx("div",{className:"mt-3 pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Total Medicines:"}),e.jsx("span",{children:n.medicines.filter(i=>i.medicine_id).length})]})})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(o,{type:"button",variant:"outline",onClick:()=>{confirm("Are you sure you want to clear all form data?")&&I()},children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Clear Form"]}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>{const i={...n,medicines:n.medicines.filter(s=>s.medicine_id)};localStorage.setItem("prescription_draft",JSON.stringify(i)),alert("Prescription saved as draft!")},children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"Save as Draft"]}),e.jsxs(o,{type:"button",variant:"outline",onClick:()=>{const i=window.open("","_blank"),s=n.medicines.filter(a=>a.medicine_id),t=c&&c.length>0?c[0]:null;i.document.write(`
                                            <html>
                                                <head><title>Prescription Preview</title></head>
                                                <body style="font-family: Arial, sans-serif; padding: 20px;">
                                                    <h2>Prescription for ${m?.firstname} ${m?.lastname}</h2>
                                                    <p><strong>Doctor:</strong> ${t?.user?t.user.firstname+" "+t.user.lastname:"Not selected"}</p>
                                                    <p><strong>Date:</strong> ${n.prescription_date}</p>
                                                    <p><strong>Case ID:</strong> ${n.case_id||"Not selected"}</p>
                                                    <hr>
                                                    <h3>Medicines:</h3>
                                                    ${s.map(a=>{const d=h.find(r=>r.id==a.medicine_id);return`
                                                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                                                                <strong>${d?.name||"Unknown"}</strong><br>
                                                                Dosage: ${a.dosage}<br>
                                                                Frequency: ${a.frequency}<br>
                                                                Duration: ${a.duration}<br>
                                                                Quantity: ${a.quantity} ${d?.unit||""}<br>
                                                                ${a.instructions?`Instructions: ${a.instructions}`:""}
                                                            </div>
                                                        `}).join("")}
                                                </body>
                                            </html>
                                        `),i.document.close(),i.print()},children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Print Preview"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:_,children:"Cancel"}),e.jsx(o,{type:"submit",disabled:b,children:b?"Creating...":"Create Prescription"})]})]})]})})]})})}export{Ce as default};
