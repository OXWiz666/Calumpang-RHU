import{u as M,j as e,r as T}from"./app-C8tI36y-.js";import{r as o}from"./vendor-DkBadjUr.js";import{D as L,a as H,b as U,c as O}from"./dialog-ROlFfije.js";import{B as _}from"./button-B7RYL61J.js";import{I as h}from"./input-DyBsoQup.js";import{L as u}from"./label-BZn2K1na.js";import{T as R}from"./textarea-BxJGceb_.js";import{S as N}from"./shopping-cart-CMDRxEaq.js";import{m as V}from"./proxy-Do-zny-D.js";import{H as X}from"./hash-AgYeaIxt.js";import{C as z}from"./calendar-D9APQM2e.js";import{C as G}from"./circle-x-Cf2XhiVO.js";import{T as J}from"./triangle-alert-BslwqqvL.js";import{C as K}from"./circle-check-big-BQVCuGNJ.js";import"./pusher-DVtoYAOu.js";import"./react-icons.esm-BKesc81l.js";import"./index-BgM2LvZ7.js";import"./index-CR41gQkc.js";import"./tslib.es6-M_FJ09fS.js";import"./index-DorOO4sg.js";import"./createLucideIcon-BKWaAi2G.js";const Ne=({open:g,onClose:y,item:i})=>{const[v,q]=o.useState([]),[d,x]=o.useState({}),[w,b]=o.useState(!1),[l,p]=o.useState([]),[W,Y]=o.useState({}),[Z,D]=o.useState(i?.quantity||0),{data:r,setData:c,post:C,processing:j,errors:ee}=M({item_id:i?.id||"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:""}),S=t=>{const s=new Date;return t.filter(a=>{if(!a.expiry_date||a.expiry_date==="N/A")return!0;try{return new Date(a.expiry_date)>s}catch{return!0}})},$=async()=>{if(i?.id){b(!0);try{const t=await fetch(`/pharmacist/inventory/item/${i.id}/batches`);if(t.ok){const s=await t.json(),a=S(Array.isArray(s)?s:[]);q(a)}}catch(t){console.error("Error loading batches:",t)}finally{b(!1)}}};o.useEffect(()=>{g&&i&&($(),c("item_id",i.id),c("dispensed_by","Current User"),D(i.quantity||0),p([]),c("batch_id",""))},[g,i]);const B=(t,s)=>{const a=`${t.batch_number}-${s}-${t.batch_id||t.id}`;p(n=>n.find(f=>f.uniqueId===a)?n.filter(f=>f.uniqueId!==a):[...n,{...t,uniqueId:a,quantity:t.available_quantity||0}]),c({...r,batch_number:t.batch_number,quantity:t.available_quantity||0}),x({})},E=(t,s)=>{p(a=>a.map(n=>n.uniqueId===t?{...n,quantity:Math.max(0,Math.min(s,n.available_quantity||0))}:n))},I=()=>{const t={};return l.length===0&&(t.batch_number="Please select at least one batch"),r.patient_name.trim()||(t.patient_name="Please enter patient name"),r.case_id.trim()||(t.case_id="Please enter case ID"),r.reason.trim()||(t.reason="Please provide a reason for dispensing"),l.reduce((a,n)=>a+(n.quantity||0),0)<=0&&(t.quantity="Please enter valid quantities for selected batches"),x(t),Object.keys(t).length===0},A=t=>{t.preventDefault(),I()&&(l.reduce((s,a)=>s+(a.quantity||0),0),r.item_id,l[0]?.batch_id||l[0]?.id,l[0]?.batch_number,r.reason,r.patient_name,r.case_id,r.dispensed_by,r.notes,l.map(s=>({batch_id:s.batch_id||s.id,batch_number:s.batch_number,quantity:s.quantity})),C(route("pharmacist.inventory.dispense"),{onSuccess:()=>{y(),T.visit(window.location.pathname,{method:"get"}),c({item_id:"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:""}),p([]),x({}),window.location.reload()},onError:s=>{console.error("Dispense error:",s),x(s)}}))},k=t=>t?new Date(t).toLocaleDateString():"N/A",P=t=>t?new Date(t)<new Date:!1,Q=t=>{if(!t)return!1;const s=new Date(t),n=Math.ceil((s-new Date)/(1e3*60*60*24));return n<=30&&n>0},F=t=>P(t)?{status:"expired",color:"text-red-600",bgColor:"bg-red-50",icon:e.jsx(G,{className:"h-4 w-4"})}:Q(t)?{status:"expiring",color:"text-amber-600",bgColor:"bg-amber-50",icon:e.jsx(J,{className:"h-4 w-4"})}:{status:"valid",color:"text-green-600",bgColor:"bg-green-50",icon:e.jsx(K,{className:"h-4 w-4"})};return i?e.jsx(L,{open:g,onOpenChange:y,children:e.jsxs(H,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(U,{children:e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-5 w-5 text-green-600"}),"Dispense Stock - ",i.name]})}),e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Item Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.manufacturer||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.category?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Stock:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[i.quantity||0," ",i.unit_type||"units"]})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-sm font-medium",children:"Available Batches"}),e.jsx("div",{className:"mt-2 space-y-2",children:w?e.jsx("div",{className:"text-center py-4",children:"Loading batches..."}):v.map((t,s)=>{const a=F(t.expiry_date),n=l.some(m=>m.uniqueId===`${t.batch_number}-${s}-${t.batch_id||t.id}`);return e.jsxs(V.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:s*.1},className:`p-3 border rounded-lg cursor-pointer transition-all ${n?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>B(t,s),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n?"bg-green-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:t.batch_number}),e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded-full text-xs ${a.bgColor} ${a.color}`,children:[a.icon,a.status==="expired"?"Expired":a.status==="expiring"?"Expiring Soon":"Valid"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Available: ",t.available_quantity," units"]})]})]}),e.jsx("div",{className:"text-right text-sm text-gray-600",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{className:"h-4 w-4"}),k(t.expiry_date)]})})]}),n&&e.jsxs("div",{className:"mt-3 pl-7",children:[e.jsx(u,{className:"text-xs",children:"Quantity to dispense for this batch"}),e.jsx(h,{type:"number",min:0,max:t.available_quantity,value:l.find(m=>m.uniqueId===`${t.batch_number}-${s}-${t.batch_id||t.id}`)?.quantity||0,onChange:m=>E(`${t.batch_number}-${s}-${t.batch_id||t.id}`,parseInt(m.target.value)||0),className:"mt-1 w-40"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Max ",t.available_quantity]})]})]},`${t.batch_number}-${s}`)})}),d.batch_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.batch_number})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"patient_name",children:"Patient Name *"}),e.jsx(h,{id:"patient_name",value:r.patient_name,onChange:t=>c("patient_name",t.target.value),className:"mt-1",placeholder:"Enter patient name"}),d.patient_name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.patient_name})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"case_id",children:"Case ID *"}),e.jsx(h,{id:"case_id",value:r.case_id,onChange:t=>c("case_id",t.target.value),className:"mt-1",placeholder:"Enter case ID"}),d.case_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.case_id})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"reason",children:"Reason for Dispensing *"}),e.jsx(h,{id:"reason",value:r.reason,onChange:t=>c("reason",t.target.value),className:"mt-1",placeholder:"Enter reason for dispensing"}),d.reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.reason})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"notes",children:"Additional Notes"}),e.jsx(R,{id:"notes",value:r.notes,onChange:t=>c("notes",t.target.value),placeholder:"Any additional notes...",className:"mt-1",rows:3})]}),l.length>0&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h4",{className:"font-semibold text-green-900 mb-2 flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4"}),"Dispense Summary"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Total Quantity:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[l.reduce((t,s)=>t+(s.quantity||0),0)," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Selected Batches:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Patient:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.patient_name||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Case ID:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.case_id||"Not specified"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t",children:[e.jsx(_,{type:"button",variant:"outline",onClick:y,disabled:j,children:"Cancel"}),e.jsx(_,{type:"submit",disabled:j||l.length===0,className:"bg-green-600 hover:bg-green-700 text-white",children:j?"Dispensing...":"Dispense Stock"})]})]})]})}):null};export{Ne as default};
