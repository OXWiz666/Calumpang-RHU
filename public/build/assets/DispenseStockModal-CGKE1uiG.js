import{u as M,j as e}from"./app-Jdp7iNzl.js";import{r as o}from"./vendor-DkBadjUr.js";import{D as T,a as L,b as H,c as U}from"./dialog-Dbk7O2i8.js";import{B as _}from"./button-bex_LU9I.js";import{I as h}from"./input-NCJ_n0W_.js";import{L as u}from"./label-CGwfsoC9.js";import{T as O}from"./textarea-hvcYZMC6.js";import{S as N}from"./shopping-cart-CMDRxEaq.js";import{m as R}from"./proxy-FTaFPFFz.js";import{H as V}from"./hash-AgYeaIxt.js";import{C as X}from"./calendar-D9APQM2e.js";import{C as z}from"./circle-x-Cf2XhiVO.js";import{T as G}from"./triangle-alert-BslwqqvL.js";import{C as J}from"./circle-check-big-BQVCuGNJ.js";import"./pusher-DVtoYAOu.js";import"./react-icons.esm-DopY43hH.js";import"./index-C03ciVM9.js";import"./index-CnT-AOMH.js";import"./tslib.es6-M_FJ09fS.js";import"./index-lVX1eI0n.js";import"./createLucideIcon-BKWaAi2G.js";const _e=({open:g,onClose:y,item:i})=>{const[v,q]=o.useState([]),[d,x]=o.useState({}),[D,b]=o.useState(!1),[l,p]=o.useState([]),[K,W]=o.useState({}),[Y,C]=o.useState(i?.quantity||0),{data:r,setData:c,post:S,processing:j,errors:Z}=M({item_id:i?.id||"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:""}),w=s=>{const t=new Date;return s.filter(a=>{if(!a.expiry_date||a.expiry_date==="N/A")return!0;try{return new Date(a.expiry_date)>t}catch{return!0}})},$=async()=>{if(i?.id){b(!0);try{const s=await fetch(`/pharmacist/inventory/item/${i.id}/batches`);if(s.ok){const t=await s.json(),a=w(Array.isArray(t)?t:[]);q(a)}}catch(s){console.error("Error loading batches:",s)}finally{b(!1)}}};o.useEffect(()=>{g&&i&&($(),c("item_id",i.id),c("dispensed_by","Current User"),C(i.quantity||0),p([]),c("batch_id",""))},[g,i]);const B=(s,t)=>{const a=`${s.batch_number}-${t}-${s.batch_id||s.id}`;p(n=>n.find(f=>f.uniqueId===a)?n.filter(f=>f.uniqueId!==a):[...n,{...s,uniqueId:a,quantity:s.available_quantity||0}]),c({...r,batch_number:s.batch_number,quantity:s.available_quantity||0}),x({})},E=(s,t)=>{p(a=>a.map(n=>n.uniqueId===s?{...n,quantity:Math.max(0,Math.min(t,n.available_quantity||0))}:n))},I=()=>{const s={};return l.length===0&&(s.batch_number="Please select at least one batch"),r.patient_name.trim()||(s.patient_name="Please enter patient name"),r.case_id.trim()||(s.case_id="Please enter case ID"),r.reason.trim()||(s.reason="Please provide a reason for dispensing"),l.reduce((a,n)=>a+(n.quantity||0),0)<=0&&(s.quantity="Please enter valid quantities for selected batches"),x(s),Object.keys(s).length===0},A=s=>{s.preventDefault(),I()&&(l.reduce((t,a)=>t+(a.quantity||0),0),r.item_id,l[0]?.batch_id||l[0]?.id,l[0]?.batch_number,r.reason,r.patient_name,r.case_id,r.dispensed_by,r.notes,l.map(t=>({batch_id:t.batch_id||t.id,batch_number:t.batch_number,quantity:t.quantity})),S(route("pharmacist.inventory.dispense"),{onSuccess:()=>{y(),c({item_id:"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:""}),p([]),x({}),window.location.reload()},onError:t=>{console.error("Dispense error:",t),x(t)}}))},k=s=>s?new Date(s).toLocaleDateString():"N/A",P=s=>s?new Date(s)<new Date:!1,Q=s=>{if(!s)return!1;const t=new Date(s),n=Math.ceil((t-new Date)/(1e3*60*60*24));return n<=30&&n>0},F=s=>P(s)?{status:"expired",color:"text-red-600",bgColor:"bg-red-50",icon:e.jsx(z,{className:"h-4 w-4"})}:Q(s)?{status:"expiring",color:"text-amber-600",bgColor:"bg-amber-50",icon:e.jsx(G,{className:"h-4 w-4"})}:{status:"valid",color:"text-green-600",bgColor:"bg-green-50",icon:e.jsx(J,{className:"h-4 w-4"})};return i?e.jsx(T,{open:g,onOpenChange:y,children:e.jsxs(L,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(H,{children:e.jsxs(U,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-5 w-5 text-green-600"}),"Dispense Stock - ",i.name]})}),e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Item Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.manufacturer||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"ml-2 font-medium",children:i.category?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Stock:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[i.quantity||0," ",i.unit_type||"units"]})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-sm font-medium",children:"Available Batches"}),e.jsx("div",{className:"mt-2 space-y-2",children:D?e.jsx("div",{className:"text-center py-4",children:"Loading batches..."}):v.map((s,t)=>{const a=F(s.expiry_date),n=l.some(m=>m.uniqueId===`${s.batch_number}-${t}-${s.batch_id||s.id}`);return e.jsxs(R.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:t*.1},className:`p-3 border rounded-lg cursor-pointer transition-all ${n?"border-green-500 bg-green-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>B(s,t),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n?"bg-green-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:s.batch_number}),e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded-full text-xs ${a.bgColor} ${a.color}`,children:[a.icon,a.status==="expired"?"Expired":a.status==="expiring"?"Expiring Soon":"Valid"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Available: ",s.available_quantity," units"]})]})]}),e.jsx("div",{className:"text-right text-sm text-gray-600",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"h-4 w-4"}),k(s.expiry_date)]})})]}),n&&e.jsxs("div",{className:"mt-3 pl-7",children:[e.jsx(u,{className:"text-xs",children:"Quantity to dispense for this batch"}),e.jsx(h,{type:"number",min:0,max:s.available_quantity,value:l.find(m=>m.uniqueId===`${s.batch_number}-${t}-${s.batch_id||s.id}`)?.quantity||0,onChange:m=>E(`${s.batch_number}-${t}-${s.batch_id||s.id}`,parseInt(m.target.value)||0),className:"mt-1 w-40"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Max ",s.available_quantity]})]})]},`${s.batch_number}-${t}`)})}),d.batch_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.batch_number})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"patient_name",children:"Patient Name *"}),e.jsx(h,{id:"patient_name",value:r.patient_name,onChange:s=>c("patient_name",s.target.value),className:"mt-1",placeholder:"Enter patient name"}),d.patient_name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.patient_name})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"case_id",children:"Case ID *"}),e.jsx(h,{id:"case_id",value:r.case_id,onChange:s=>c("case_id",s.target.value),className:"mt-1",placeholder:"Enter case ID"}),d.case_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.case_id})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"reason",children:"Reason for Dispensing *"}),e.jsx(h,{id:"reason",value:r.reason,onChange:s=>c("reason",s.target.value),className:"mt-1",placeholder:"Enter reason for dispensing"}),d.reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:d.reason})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"notes",children:"Additional Notes"}),e.jsx(O,{id:"notes",value:r.notes,onChange:s=>c("notes",s.target.value),placeholder:"Any additional notes...",className:"mt-1",rows:3})]}),l.length>0&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("h4",{className:"font-semibold text-green-900 mb-2 flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4"}),"Dispense Summary"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Total Quantity:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[l.reduce((s,t)=>s+(t.quantity||0),0)," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Selected Batches:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Patient:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.patient_name||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700",children:"Case ID:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.case_id||"Not specified"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t",children:[e.jsx(_,{type:"button",variant:"outline",onClick:y,disabled:j,children:"Cancel"}),e.jsx(_,{type:"submit",disabled:j||l.length===0,className:"bg-green-600 hover:bg-green-700 text-white",children:j?"Dispensing...":"Dispense Stock"})]})]})]})}):null};export{_e as default};
