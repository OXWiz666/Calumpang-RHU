import{j as e,r as le}from"./app-Jdp7iNzl.js";import{r as c}from"./vendor-DkBadjUr.js";import{t as d,a as Ne}from"./toast-CW2_iv-L.js";import{z as Se}from"./index-WHihrx3k.js";import{D as _e,a as we,b as Be,c as Ce}from"./dialog-Dbk7O2i8.js";import{B as A}from"./button-bex_LU9I.js";import{I as _}from"./input-NCJ_n0W_.js";import{B as z}from"./badge-CxjsEXIx.js";import{C as Ie}from"./checkbox-NMyKY7VH.js";import{S as Ee,a as Me,b as Ue,c as Pe,d as Ae}from"./select-CspDrWdj.js";import{T as ne}from"./trending-up-BFbz08q-.js";import{P as qe}from"./plus-MavOGQlj.js";import{S as Le}from"./search-Cye_TdpF.js";import{T as De}from"./triangle-alert-BslwqqvL.js";import{m as Te}from"./proxy-FTaFPFFz.js";import{P as $e}from"./package-L7rgkkVO.js";import{C as Ve}from"./check-BD0Yvgxs.js";import{H as Oe}from"./hash-AgYeaIxt.js";import"./pusher-DVtoYAOu.js";import"./use-toast-Dm0PN6fH.js";import"./refresh-cw-D3hZ7e_O.js";import"./createLucideIcon-BKWaAi2G.js";import"./save-CAdd64LS.js";import"./square-pen-Bb1JtfBr.js";import"./download-BH8XyxCx.js";import"./trash-2-DJ5zXW8D.js";import"./archive-BwGVl8jP.js";import"./info-BVLwYIm5.js";import"./circle-x-Cf2XhiVO.js";import"./circle-check-F3PuHnLX.js";import"./react-icons.esm-DopY43hH.js";import"./index-C03ciVM9.js";import"./index-CnT-AOMH.js";import"./tslib.es6-M_FJ09fS.js";import"./index-lVX1eI0n.js";import"./index-DqxisvwK.js";import"./index-at3TdkEY.js";import"./index-B2TPyuzg.js";import"./index-CQJFG6sX.js";import"./index-BhA1pP3R.js";import"./index-BuhCV9Ak.js";function It({open:ce,onClose:ie,inventoryItems:H=[]}){const[m,T]=c.useState([]),[C,$]=c.useState({}),[R,I]=c.useState({}),[w,W]=c.useState(""),[E,oe]=c.useState([]),[f,Y]=c.useState("add"),[i,G]=c.useState(""),[V,M]=c.useState(!1),[de,J]=c.useState({}),[v,U]=c.useState(1),[q]=c.useState(10),[h,K]=c.useState(""),[p,X]=c.useState(""),[N,Z]=c.useState(""),[L,ee]=c.useState(""),[P,te]=c.useState(""),[u,S]=c.useState({});c.useEffect(()=>{const t={};H.forEach(a=>{if(a.status!==0){const l=a.name.toLowerCase();(!t[l]||a.id>t[l].id)&&(t[l]=a)}});const s=Object.values(t).filter(a=>a.name.toLowerCase().includes(w.toLowerCase())||(a.category?.name||"Uncategorized").toLowerCase().includes(w.toLowerCase())||(a.manufacturer||"").toLowerCase().includes(w.toLowerCase())||(a.supplier||"").toLowerCase().includes(w.toLowerCase()));oe(s),U(1)},[w,H]);const me=async t=>{if(!t){I(s=>({...s,[t]:[]}));return}J(s=>({...s,[t]:!0}));try{const s=await fetch(`/pharmacist/inventory/item/${t}/batches`);if(s.ok){const a=await s.json();console.log("Loaded batches for item",t,":",a),I(l=>({...l,[t]:Array.isArray(a)?a:[]}))}else console.error("Failed to load batches:",s.status),I(a=>({...a,[t]:[]}))}catch(s){console.error("Error loading batches:",s),I(a=>({...a,[t]:[]}))}finally{J(s=>({...s,[t]:!1}))}},ue=(t,s)=>{if(!t||!t.id){console.error("Invalid item selected:",t);return}console.log("Selecting item:",t,"checked:",s),s?(T(a=>[...a,t]),me(t.id)):(T(a=>a.filter(l=>l.id!==t.id)),$(a=>{const l={...a};return delete l[t.id],l}))},he=(t,s,a)=>{$(l=>{const n=l[t]||[];return a?{...l,[t]:[...n,s]}:{...l,[t]:n.filter(x=>x!==s)}})},pe=async()=>{if(m.length===0){d("No Items Selected","Please select at least one item to update.");return}const t=parseInt(h)||0,s=parseInt(p)||0,a={};if(t<0&&(a.minimum_stock="Minimum stock level cannot be negative."),s<0&&(a.maximum_stock="Maximum stock level cannot be negative."),t>0&&s>0&&t>s&&(a.minimum_stock="Minimum stock level cannot be greater than maximum stock level."),!P||P.trim()==="")a.expiry_date="Expiry date is required.";else{const l=new Date(P),n=new Date;n.setHours(0,0,0,0),l<n&&(a.expiry_date="Expiry date cannot be in the past.")}if(Object.keys(a).length>0){S(a),Se.error("Please fix the validation errors before submitting.");return}if(S({}),!i||isNaN(parseInt(i))||parseInt(i)<=0){d("Invalid Quantity","Please enter a valid quantity value.");return}if(!h||isNaN(parseInt(h))||parseInt(h)<0){d("Invalid Minimum Stock","Please enter a valid minimum stock level.");return}if(!p||isNaN(parseInt(p))||parseInt(p)<0){d("Invalid Maximum Stock","Please enter a valid maximum stock level.");return}if(!N||N.trim()===""){d("Missing Supplier","Please enter a supplier name.");return}if(parseInt(p)<=parseInt(h)){d("Invalid Stock Levels","Maximum stock level must be greater than minimum stock level.");return}M(!0);try{const l=parseInt(i),n=[],x=[],y=[];let B=0;if(m.forEach(r=>{const o=C[r.id]||[];B+=o.length,o.length>0?x.push({item:r,selectedBatches:o}):y.push(r)}),B>0&&y.length>0){const r=`You have selected ${B} batch(es) but ${y.length} item(s) have no batches selected. Please either select batches for all items or deselect items that don't have batches selected.`;d("Batch Selection Error",r),M(!1);return}if(m.forEach(r=>{const o=R[r.id]||[],re=C[r.id]||[];if(re.length===0){const j=r.stock?.stocks||0;let b=j;switch(f){case"add":b=j+l;break;case"subtract":b=Math.max(0,j-l);break;default:b=j}n.push({item_id:r.id,current_quantity:j,new_quantity:b,update_type:f,update_amount:l,is_batch_update:!1})}else re.forEach(j=>{const b=o.find(k=>String(k.batch_id||k.id)===String(j));if(b){const k=b.available_quantity||0;let D=k;switch(f){case"add":D=k+l;break;case"subtract":D=Math.max(0,k-l);break;default:D=k}n.push({item_id:r.id,batch_id:b.batch_id||b.id,batch_number:b.batch_number,current_quantity:k,new_quantity:D,update_type:f,update_amount:l,is_batch_update:!0})}else console.warn(`Batch ${j} not found for item ${r.name}`)})}),n.length===0){d("No Items to Update","No valid items found for update. Please check your selections and try again."),M(!1);return}console.log("Bulk Update Data:",{totalItems:n.length,updateType:f,updateAmount:l,items:n.map(r=>({item_id:r.item_id,is_batch_update:r.is_batch_update,batch_number:r.batch_number||"N/A",current_quantity:r.current_quantity,new_quantity:r.new_quantity}))}),le.post(route("pharmacist.inventory.update.bulk"),{items:n,update_type:f,update_amount:i,update_date:new Date().toISOString().split("T")[0],minimum_stock:h||null,maximum_stock:p||null,supplier:N||null,reason:L||null,expiry_date:P||null},{onSuccess:r=>{console.log("Bulk update successful:",r),Ne("Bulk Update Successful",`Bulk update completed successfully! Updated ${n.length} item(s).`,"update"),O(),le.visit(window.location.pathname,{method:"get"})},onError:r=>{if(console.error("Bulk update error:",r),r&&typeof r=="object"){const o=[];r.minimum_stock&&o.push(`Minimum stock: ${Array.isArray(r.minimum_stock)?r.minimum_stock[0]:r.minimum_stock}`),r.maximum_stock&&o.push(`Maximum stock: ${Array.isArray(r.maximum_stock)?r.maximum_stock[0]:r.maximum_stock}`),r.supplier&&o.push(`Supplier: ${Array.isArray(r.supplier)?r.supplier[0]:r.supplier}`),r.items&&o.push(`Items: ${Array.isArray(r.items)?r.items[0]:r.items}`),r.update_value&&o.push(`Update value: ${Array.isArray(r.update_value)?r.update_value[0]:r.update_value}`),o.length>0?d("Validation Errors",o.join(", ")):d("Bulk Update Failed","Please check your inputs and try again.")}else typeof r=="string"?d("Bulk Update Error",r):d("Bulk Update Failed","An unexpected error occurred. Please try again.")},onFinish:()=>{M(!1)}})}catch(l){console.error("Bulk update error:",l),d("Bulk Update Error","An unexpected error occurred during bulk update. Please try again."),M(!1)}},O=()=>{T([]),$({}),I({}),Y("add"),G(""),W(""),K(""),X(""),Z(""),ee(""),te(""),U(1),S({}),ie()},F=Math.ceil(E.length/q),Q=(v-1)*q,se=Q+q,xe=E.slice(Q,se),ge=t=>{U(t)},be=()=>{v>1&&U(v-1)},fe=()=>{v<F&&U(v+1)},ve=t=>{const s=t.stock?.stocks||0,a=t.minimum_stock||10;return s===0?"out_of_stock":s<=a?"low_stock":"in_stock"},ye=t=>{switch(t){case"in_stock":return"bg-green-100 text-green-800 border-green-200";case"low_stock":return"bg-amber-100 text-amber-800 border-amber-200";case"out_of_stock":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},je=t=>{switch(t){case"in_stock":return"In Stock";case"low_stock":return"Low Stock";case"out_of_stock":return"Out of Stock";default:return"Unknown"}},ke=t=>{switch(t){case"add":return"Add to Stock";case"subtract":return"Subtract from Stock";default:return"Update Stock"}},ae=t=>{if(!i)return t;const s=parseInt(i)||0;switch(f){case"add":return t+s;case"subtract":return Math.max(0,t-s);default:return t}},g=()=>Object.values(C).reduce((t,s)=>t+s.length,0);return e.jsx(_e,{open:ce,onOpenChange:O,children:e.jsxs(we,{className:"max-w-4xl max-h-[90vh] overflow-hidden",children:[e.jsx(Be,{children:e.jsxs(Ce,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-blue-600"}),"Bulk Update Stock"]})}),e.jsxs("div",{className:"space-y-6 overflow-y-auto max-h-[70vh]",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Update Type"}),e.jsxs(Ee,{value:f,onValueChange:Y,children:[e.jsx(Me,{className:"w-full",children:e.jsx(Ue,{placeholder:"Select update type"})}),e.jsx(Pe,{children:e.jsx(Ae,{value:"add",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4 text-green-600"}),"Add to Stock"]})})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity Value *"}),e.jsx(_,{type:"number",min:"1",value:i,onChange:t=>{const s=t.target.value;G(s);const a=parseInt(s)||0,l={...u};a<=0?l.update_value="Quantity value must be greater than 0.":delete l.update_value,S(l)},placeholder:"Enter quantity",className:"w-full",required:!0}),u.update_value&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.update_value})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-blue-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Minimum Stock Level *"}),e.jsx(_,{type:"number",min:"0",value:h,onChange:t=>{const s=t.target.value;K(s);const a=parseInt(s)||0,l=parseInt(p)||0,n={...u};a<0?n.minimum_stock="Minimum stock level cannot be negative.":l>0&&a>=l?n.minimum_stock="Minimum stock level must be less than maximum stock level.":delete n.minimum_stock,S(n)},placeholder:"Enter minimum stock level",className:"w-full",required:!0}),u.minimum_stock&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.minimum_stock})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Maximum Stock Level *"}),e.jsx(_,{type:"number",min:"0",value:p,onChange:t=>{const s=t.target.value;X(s);const a=parseInt(s)||0,l=parseInt(h)||0,n={...u};a<0?n.maximum_stock="Maximum stock level cannot be negative.":l>0&&a<=l?n.maximum_stock="Maximum stock level must be greater than minimum stock level.":delete n.maximum_stock,S(n)},placeholder:"Enter maximum stock level",className:"w-full",required:!0}),u.maximum_stock&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.maximum_stock})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier *"}),e.jsx(_,{value:N,onChange:t=>Z(t.target.value),placeholder:"Enter supplier name",className:"w-full",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsx(_,{value:L,onChange:t=>ee(t.target.value),placeholder:"Update reason (optional)",className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Expiry Date *"}),e.jsx(_,{type:"date",value:P,onChange:t=>{te(t.target.value);const s={...u};t.target.value&&new Date(t.target.value)<new Date().setHours(0,0,0,0)?s.expiry_date="Expiry date cannot be in the past.":delete s.expiry_date,S(s)},placeholder:"Select expiry date",className:"w-full",required:!0,min:new Date().toISOString().split("T")[0]}),u.expiry_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.expiry_date})]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Select Items"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),e.jsx(_,{placeholder:"Search items by name, category, manufacturer, or supplier...",value:w,onChange:t=>W(t.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(z,{variant:"outline",className:"text-sm",children:[m.length," item",m.length!==1?"s":""," selected"]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[g()," batch",g()!==1?"es":""," selected"]})]}),g()>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(De,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Batch Selection Summary"})]}),e.jsx("div",{className:"text-sm text-blue-700",children:Object.entries(C).map(([t,s])=>{const a=m.find(l=>l.id===t);return e.jsxs("div",{className:"mb-1",children:[e.jsx("strong",{children:a?.name}),": ",s.length," batch(es) selected"]},t)})})]})]})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:xe.map(t=>{const s=m.some(x=>x.id===t.id),a=ve(t),l=t.stock?.stocks||0,n=ae(l);return e.jsx(Te.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`p-4 border rounded-lg transition-all ${s?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ie,{checked:s,onCheckedChange:x=>ue(t,x),className:"h-4 w-4"}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($e,{className:"h-5 w-5 text-gray-600"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[e.jsxs("p",{children:[t.category?.name||"Uncategorized"," • ",t.manufacturer||"Unknown Manufacturer"]}),e.jsxs("p",{children:["Supplier: ",t.supplier||"Not Set"," • Min: ",t.minimum_stock||"Not Set"," • Max: ",t.maximum_stock||"Not Set"]})]})]})]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:ye(a),children:je(a)}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:[l," → ",n," units"]}),s&&i&&e.jsxs(z,{variant:"outline",className:n>l?"text-green-600 border-green-300":n<l?"text-red-600 border-red-300":"text-blue-600 border-blue-300",children:["+",i]})]})]})]})},t.id)})}),E.length>q&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gray-50 border-t",children:[e.jsx("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:e.jsxs("span",{children:["Showing ",Q+1," to ",Math.min(se,E.length)," of ",E.length," items"]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{variant:"outline",size:"sm",onClick:be,disabled:v===1,className:"px-3 py-1",children:"Previous"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:F},(t,s)=>s+1).map(t=>e.jsx(A,{variant:v===t?"default":"outline",size:"sm",onClick:()=>ge(t),className:"w-8 h-8 p-0",children:t},t))}),e.jsx(A,{variant:"outline",size:"sm",onClick:fe,disabled:v===F,className:"px-3 py-1",children:"Next"})]})]}),m.length>0&&e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Select Batches for Each Item"}),e.jsx("div",{className:"space-y-4",children:m.map(t=>{const s=R[t.id]||[],a=C[t.id]||[],l=de[t.id];return e.jsxs("div",{className:"p-3 bg-white border rounded-lg",children:[e.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:t.name}),l?e.jsx("div",{className:"text-center py-4",children:"Loading batches..."}):s.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"Select batches to update:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:s.map(n=>{const x=String(n.batch_id||n.id),y=a.includes(x),B=n.available_quantity||0,r=ae(B);return e.jsx("div",{className:`p-3 border rounded-lg cursor-pointer transition-all ${y?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>he(t.id,x,!y),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-4 h-4 rounded border-2 flex items-center justify-center ${y?"bg-blue-500 border-blue-500":"border-gray-300"}`,children:y&&e.jsx(Ve,{className:"h-3 w-3 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:n.batch_number||"N/A"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[B," → ",r," units",n.expiry_date&&n.expiry_date!=="N/A"&&e.jsxs("span",{className:"ml-2",children:["(Exp: ",new Date(n.expiry_date).toLocaleDateString(),")"]})]})]})]})},x)})})]}):e.jsx("div",{className:"text-center py-4 text-gray-500",children:"No batches available for this item"})]},t.id)})})]}),m.length>0&&g()>0&&i&&h&&p&&N&&e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Update Summary"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-800",children:[e.jsxs("p",{children:["Items: ",m.length]}),e.jsxs("p",{children:["Batches: ",g()]}),e.jsxs("p",{children:["Update Type: ",ke(f)]}),e.jsxs("p",{children:["Update Value: ",i]}),e.jsxs("p",{children:["Min Stock: ",h]}),e.jsxs("p",{children:["Max Stock: ",p]}),e.jsxs("p",{children:["Supplier: ",N]}),L&&e.jsxs("p",{children:["Reason: ",L]}),e.jsx("div",{className:"mt-2",children:e.jsxs("p",{className:"text-xs",children:["Total updates: ",g()," batch",g()!==1?"es":""]})})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t",children:[e.jsx(A,{variant:"outline",onClick:O,disabled:V,children:"Cancel"}),e.jsx(A,{onClick:pe,disabled:m.length===0||g()===0||!i||!h||!p||!N||V,className:"bg-blue-600 hover:bg-blue-700",children:V?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Update ",g()," Batch",g()!==1?"es":""]})})]})]})})}export{It as default};
