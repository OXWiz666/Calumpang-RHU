import{j as e,a as ce}from"./app-Ci6FsPEI.js";import{r as d,R as de}from"./vendor-DkBadjUr.js";import{B as V}from"./button-CNgURIMK.js";import{I}from"./input-CCqrrlXQ.js";import{I as T}from"./InputError-eluy_kMo.js";import{L as v}from"./label-Bsu9V-2p.js";import{S as J,a as Y,b as U,c as X,d as S}from"./select-Bs3uVyOJ.js";import be from"./CustomCalendar-DezlMiL6.js";import{h as G}from"./moment-C5S46NFB.js";import{t as me,P as ve}from"./PhilippinesAddressLookup-dl9KrQEZ.js";import{C as je,a as ye,b as Ne,c as we}from"./card-aZhT47Dl.js";import{C as _e}from"./clock-D6yUBuGv.js";import"./pusher-DVtoYAOu.js";import"./index-BpVWxWkG.js";import"./react-icons.esm-Cg1Z9ZGK.js";import"./index-B6i_t9H1.js";import"./index-D0_reY7q.js";import"./index-BYyo8n0W.js";import"./tslib.es6-M_FJ09fS.js";import"./index-DbZPFhJ9.js";import"./index-CuaviD7G.js";import"./index-DqxisvwK.js";import"./index-MVKj6Ku2.js";import"./chevron-left-B36-TXNE.js";import"./createLucideIcon-BKWaAi2G.js";import"./chevron-right-B3qqnx4D.js";import"./isBefore-COsor6RJ.js";import"./format-Dp3w_Y3x.js";import"./circle-check-big-BQVCuGNJ.js";import"./circle-alert-D8zT41fC.js";import"./circle-x-Cf2XhiVO.js";import"./isSameMonth-BOwz-_mK.js";import"./subMonths-B67T7BWk.js";const Se=({isOpen:E,onClose:n,onConfirm:p,title:t="Confirmation",message:R="Are you sure you want to confirm this appointment?",confirmText:x="Confirm",cancelText:B="Cancel"})=>E?e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm",onClick:n}),e.jsx("div",{className:"relative min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto border border-gray-100",children:[e.jsx("div",{className:"flex items-center justify-center p-6 border-b border-gray-100",children:e.jsx("div",{className:"w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-8 h-8 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"})})})}),e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4",children:t}),e.jsx("p",{className:"text-gray-600 mb-8",children:R}),e.jsxs("div",{className:"flex space-x-4 justify-center",children:[e.jsxs("button",{onClick:n,className:"px-6 py-3 text-sm font-semibold text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md flex items-center space-x-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})}),e.jsx("span",{children:B})]}),e.jsxs("button",{onClick:p,className:"px-6 py-3 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl flex items-center space-x-2 transform hover:scale-105",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:x})]})]})]})]})})]}):null,Ce=({isOpen:E,onClose:n,onVerified:p,appointmentData:t,verificationMethod:R})=>{const[x,B]=d.useState(""),[m,K]=d.useState(!1),[k,O]=d.useState(!1),[j,h]=d.useState(""),[M,P]=d.useState(300),[F,N]=d.useState(!1),[A,z]=d.useState(""),[g,y]=d.useState(0),[w,Z]=d.useState(!1),[W,H]=d.useState("N/A"),[L,Q]=d.useState(""),q=a=>a==null?"N/A":a instanceof Date?a.toLocaleDateString():String(a),$=()=>{if(!t)return"N/A";let a=t.patient_name||t.name||t.full_name;if(!a){const u=t.first_name||t.firstName||t.firstname||"",f=t.last_name||t.lastName||t.Lastname||t.lastname||"";(u||f)&&(a=`${u} ${f}`.trim())}return a&&a.trim()!==""?a.trim():"N/A"};d.useEffect(()=>{if(F&&M>0){const a=setTimeout(()=>P(M-1),1e3);return()=>clearTimeout(a)}},[F,M]),d.useEffect(()=>{if(g>0){const a=setTimeout(()=>y(g-1),1e3);return()=>clearTimeout(a)}},[g]),d.useEffect(()=>{if(t){const a=$();H(a)}},[t]),d.useEffect(()=>{if(E&&!F){let a=t?.phone||t?.mobileNo||t?.contactno||(t?.mobileCountryCode&&t?.mobileNo?t.mobileCountryCode+t.mobileNo:null);a&&(a=String(a).trim()),console.log("VerificationModal - appointmentData:",t),console.log("VerificationModal - extracted phone:",a,"type:",typeof a),a&&a!==""?(z(a),D()):h("Phone number not found in appointment data. Please check your appointment details.")}},[E]);const D=async()=>{if(w){h("Please wait, generating verification code...");return}Z(!0),h("");const a=window.location.hostname==="localhost",u=a?Math.floor(1e5+Math.random()*9e5).toString():null;a&&u&&Q(u);try{const b=await(await fetch("/api/sms/send-otp",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({phone_number:A,message:"Your SEHI appointment verification code is :otp. Valid for 5 minutes. Do not share this code with anyone."})})).json();if(b.success){N(!0),P(300),y(120),h("");const ie=b.data?.otp_code||b.data?.otp||u;Q(ie)}else a?(N(!0),P(300),y(120),h("SMS sending failed, but you can use the development code below for testing."),console.warn("SMS sending failed, using development mode:",b.message)):(h("SMS sending failed. Please try again or contact support."),console.error("SMS sending failed:",b.message))}catch(f){console.error("Error sending OTP:",f),a?(N(!0),P(300),y(120),h("SMS sending failed, but you can use the development code below for testing.")):h("SMS sending failed. Please try again or contact support.")}finally{Z(!1)}},ne=async()=>{if(!x.trim()){h("Please enter the verification code");return}if(!A){h("Phone number not found. Please try again.");return}K(!0),h("");try{const u=await(await fetch("/api/sms/verify-otp",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({phone_number:A,otp_code:x})})).json();if(u.success){console.log("OTP verified successfully, passing data to parent for appointment creation");const f={...t,firstname:t?.firstname||t?.first_name||"",lastname:t?.lastname||t?.last_name||"",email:t?.email||"",phone:A,date:t?.date||"",time:t?.time||"",service_name:t?.service_name||t?.servicename||"",subservice_name:t?.subservice_name||t?.subservicename||"",date_of_birth:t?.date_of_birth||t?.birth||"",gender:t?.gender||""};p(f)}else if(window.location.hostname==="localhost"&&L&&x===L){console.log("Development mode verification successful");const b={...t,firstname:t?.firstname||t?.first_name||"",lastname:t?.lastname||t?.last_name||"",email:t?.email||"",phone:A,date:t?.date||"",time:t?.time||"",service_name:t?.service_name||t?.servicename||"",subservice_name:t?.subservice_name||t?.subservicename||"",date_of_birth:t?.date_of_birth||t?.birth||"",gender:t?.gender||""};p(b)}else h(u.message||"Invalid verification code. Please try again.")}catch(a){if(console.error("Error verifying code:",a),window.location.hostname==="localhost"&&L&&x===L){console.log("Development mode verification successful (API failed)");const f={...t,firstname:t?.firstname||t?.first_name||"",lastname:t?.lastname||t?.last_name||"",email:t?.email||"",phone:A,date:t?.date||"",time:t?.time||"",service_name:t?.service_name||t?.servicename||"",subservice_name:t?.subservice_name||t?.subservicename||"",date_of_birth:t?.date_of_birth||t?.birth||"",gender:t?.gender||""};p(f)}else h("Failed to verify code. Please try again.")}finally{K(!1)}},ee=async()=>{if(g>0){h(`Please wait ${Math.ceil(g/60)} minutes before requesting another code.`);return}if(w){h("Please wait, generating verification code...");return}O(!0),h(""),B(""),P(300);try{await D()}catch{h("Failed to generate verification code. Please try again.")}finally{O(!1)}},te=a=>{const u=Math.floor(a/60),f=a%60;return`${u}:${f.toString().padStart(2,"0")}`};return E?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",children:e.jsxs(je,{className:"w-[500px] max-w-lg max-h-[90vh] shadow-lg rounded-lg flex flex-col",children:[e.jsxs(ye,{className:"flex flex-row items-center justify-between pb-4 flex-shrink-0",children:[e.jsxs(Ne,{className:"text-xl font-semibold flex items-center",children:[e.jsx("svg",{className:"w-6 h-6 text-blue-600 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})}),"Verify Your Appointment"]}),e.jsx(V,{variant:"ghost",onClick:n,className:"p-2",children:e.jsx("svg",{className:"w-5 h-5 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs(we,{className:"space-y-4 overflow-y-auto flex-1",children:[e.jsx("p",{className:"text-sm text-gray-600 text-center",children:"Please verify your appointment using the verification code below."}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-4 h-4 text-yellow-600 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-yellow-800",children:"Development Mode"}),e.jsx("p",{className:"text-xs text-yellow-700",children:"OTP code will be displayed below for testing."})]})]})}),e.jsxs("div",{className:"bg-gray-50 p-3 rounded-md border border-gray-200",children:[e.jsx("h4",{className:"font-semibold text-gray-800 mb-2 text-sm",children:"Appointment Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Date:"})," ",e.jsx("span",{className:"font-medium",children:q(t?.date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Time:"})," ",e.jsx("span",{className:"font-medium",children:q(t?.time)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Service:"})," ",e.jsx("span",{className:"font-medium",children:q(t?.service)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Patient:"})," ",e.jsx("span",{className:"font-medium",children:W})]})]})]}),L&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-yellow-700 font-medium mb-2",children:"Development Code:"}),e.jsx("p",{className:"text-lg font-mono text-yellow-900 bg-white p-2 rounded border border-yellow-300 text-center",children:L})]}),F&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-4 h-4 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})}),e.jsx("p",{className:"text-sm font-medium text-green-800",children:"SMS Sent Successfully"})]}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"Verification code sent to your phone. Check your SMS messages."})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("label",{htmlFor:"verificationCode",className:"block text-sm font-medium text-gray-700 mb-2",children:"Enter Verification Code"}),e.jsx("input",{id:"verificationCode",type:"text",value:x,onChange:a=>B(a.target.value),placeholder:"Enter 6-digit code",className:"w-full max-w-xs px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg text-center tracking-widest font-mono",maxLength:6}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Enter the verification code sent to your phone"})]}),!F&&e.jsx("div",{className:"text-center",children:e.jsx(V,{onClick:D,disabled:w||k,variant:"outline",size:"default",className:"px-6 py-2 text-blue-600 border-blue-200 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed",children:w||k?"Sending SMS...":"Send Verification Code"})})]}),F&&e.jsx("div",{className:"text-center space-y-2",children:M>0?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-2",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["Code expires in ",e.jsx("span",{className:"font-bold text-orange-600",children:te(M)})]}),g>0&&e.jsxs("p",{className:"text-xs text-red-600 mt-1",children:["Resend in ",Math.ceil(g/60),"m ",g%60,"s"]})]}),e.jsx(V,{onClick:ee,disabled:k||g>0||w,variant:"outline",size:"sm",className:"px-4 py-2 text-blue-600 border-blue-200 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed",children:k||w?"Sending...":g>0?`Wait ${Math.ceil(g/60)}m`:"Send New Code"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-2",children:e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Code expired"})}),e.jsx(V,{onClick:ee,disabled:k||g>0||w,variant:"outline",size:"sm",className:"px-4 py-2 text-blue-600 border-blue-200 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed",children:k||w?"Sending...":g>0?`Wait ${Math.ceil(g/60)}m`:"Send New Code"})]})}),j&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-4 h-4 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("p",{className:"text-sm font-medium text-red-800",children:j})]})}),e.jsxs("div",{className:"flex justify-center space-x-3 mt-4",children:[e.jsx(V,{variant:"outline",onClick:n,disabled:m,size:"sm",className:"px-4 py-2",children:"Cancel"}),e.jsx(V,{onClick:ne,disabled:m||!x.trim(),size:"sm",className:"px-4 py-2",children:m?"Verifying...":"Verify"})]})]})]})}):null},oi=({onSubmit:E=()=>{},formData:n,setFormData:p,errors:t,processing:R,services:x=[],setIsSubmitted:B})=>{if(console.log("AppointmentForm received formData:",n),console.log("formData type:",typeof n),console.log("formData is object:",typeof n=="object"&&n!==null),console.log("formData keys:",n&&typeof n=="object"?Object.keys(n):"not an object"),typeof n!="object"||n===null)return console.error("formData is not a valid object:",n),e.jsxs("div",{className:"p-6 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-900 mb-2",children:"Form Error"}),e.jsx("p",{className:"text-red-700",children:"There was an error loading the form data. Please refresh the page."})]});const m=ce().props.auth.user,[K,k]=d.useState(!1),[O,j]=d.useState(""),[h,M]=d.useState(!1),[P,F]=d.useState(!1),[N,A]=d.useState(!1),[z,g]=d.useState(null),[y,w]=d.useState(!1),[Z,W]=d.useState(!1),[H,L]=d.useState(null),[Q,q]=d.useState("email");d.useEffect(()=>{const s=new URLSearchParams(window.location.search).get("mode"),c=localStorage.getItem("rescheduleAppointmentData"),o=localStorage.getItem("existingPatientData"),l=localStorage.getItem("selectedPatientType");if(console.log("AppointmentForm useEffect - Mode Detection:",{mode:s,rescheduleAppointmentData:!!c,existingPatientData:!!o,patientType:l,isRescheduleMode:N,isExistingPatientMode:y}),s==="reschedule"&&c)try{const r=JSON.parse(c);A(!0),g(r),p(C=>({...typeof C=="object"&&C!==null?C:{},firstname:r.firstname||"",middlename:r.middlename||"",lastname:r.lastname||"",email:r.email||"",phone:r.phone||"",gender:r.gender||"",birth:r.date_of_birth||"",civil_status:r.civil_status||"",nationality:r.nationality||"",religion:r.religion||"",country:r.country||"",region:r.region||"",province:r.province||"",city:r.city||"",barangay:r.barangay||"",street:r.street||"",zip_code:r.zip_code||"",profile_picture:r.profile_picture||"",region_id:r.region_id||null,province_id:r.province_id||null,city_id:r.city_id||null,barangay_id:r.barangay_id||null,service:"",servicename:r.last_service||"",subservice:"",subservicename:r.last_subservice||""}))}catch(r){console.error("Error parsing reschedule data:",r)}else if(o&&l==="existing")try{const r=JSON.parse(o);w(!0),p(C=>({...typeof C=="object"&&C!==null?C:{},firstname:r.firstname||"",middlename:r.middlename||"",lastname:r.lastname||"",email:r.email||"",phone:r.phone?String(r.phone):"",gender:r.gender||"",birth:r.date_of_birth||"",civil_status:r.civil_status||"",nationality:r.nationality||"",religion:r.religion||"",country:r.country||"",region:r.region||"",province:r.province||"",city:r.city||"",barangay:r.barangay||"",street:r.street||"",zip_code:r.zip_code||"",profile_picture:r.profile_picture||"",region_id:r.region_id||null,province_id:r.province_id||null,city_id:r.city_id||null,barangay_id:r.barangay_id||null,service:"",servicename:"",subservice:"",subservicename:""})),M(!0)}catch(r){console.error("Error parsing existing patient data:",r)}else A(!1),w(!1),g(null)},[]),d.useEffect(()=>{if(N&&z&&x&&x.length>0){const i=x.find(s=>s.servicename===z.last_service);i&&(p(s=>({...typeof s=="object"&&s!==null?s:{},service:i.id,servicename:i.servicename})),fetch(`/services/get-sub-services/${i.id}`).then(s=>s.json()).then(s=>{ie(s);const c=s.find(o=>o.subservicename===z.last_subservice);if(c&&(p(o=>({...typeof o=="object"&&o!==null?o:{},subservice:c.id,subservicename:c.subservicename})),re(c.times),z.last_time)){const o=c.times.find(l=>G(l.time,"HH:mm:ss").format("hh:mm A")===z.last_time);o&&p(l=>({...typeof l=="object"&&l!==null?l:{},timeid:o.id,time:G(o.time,"HH:mm:ss").format("hh:mm A")}))}}).catch(s=>{console.error("Error fetching sub-services:",s)}))}},[N,z,x]),d.useEffect(()=>()=>{},[]),d.useEffect(()=>{m&&!n.firstname&&!N&&!y&&(p({...typeof n=="object"&&n!==null?n:{},firstname:m.firstname,middlename:m.middlename??"",lastname:m.lastname,email:m.email,phone:m.contactno?String(m.contactno):"",servicename:"",service:"",gender:m.gender,birth:m.birth,priorityNumber:"",date_of_birth:m.birth||"",civil_status:m.civil_status||"",nationality:m.nationality||"",religion:m.religion||"",country:m.country||"",region:m.region||"",province:m.province||"",city:m.city||"",barangay:m.barangay||"",street:m.street||"",zip_code:m.zip_code||"",profile_picture:m.profile_picture||"",region_id:m.region_id||null,province_id:m.province_id||null,city_id:m.city_id||null,barangay_id:m.barangay_id||null}),M(!0))},[m]),d.useEffect(()=>{if(!m)if(me.hasValidTokenSession()){const i=me.getPatientData();i&&(p({...typeof n=="object"&&n!==null?n:{},firstname:i.firstname||"",middlename:i.middlename||"",lastname:i.lastname||"",email:i.email||"",phone:i.phone?String(i.phone):"",gender:i.sex||"",birth:i.birthdate||"",servicename:"",service:"",priorityNumber:"",date_of_birth:i.birthdate||"",civil_status:i.civilStatus||"",nationality:i.nationality||"",religion:i.religion||"",country:i.country||"",region:i.region||"",province:i.province||"",city:i.city||"",barangay:i.barangay||"",street:i.street||"",zip_code:i.zipCode||"",profile_picture:i.profileImage||"",region_id:i.region_id||null,province_id:i.province_id||null,city_id:i.city_id||null,barangay_id:i.barangay_id||null}),M(!0))}else{const i=localStorage.getItem("patientVerificationData");if(i)try{const s=JSON.parse(i);p({...typeof n=="object"&&n!==null?n:{},firstname:s.firstname||"",middlename:s.middlename||"",lastname:s.lastname||"",email:s.email||"",phone:s.phone?String(s.phone):"",gender:s.sex||"",birth:s.birthdate||"",servicename:"",service:"",priorityNumber:"",date_of_birth:s.birthdate||"",civil_status:s.civilStatus||"",nationality:s.nationality||"",religion:s.religion||"",country:s.country||"",region:s.region||"",province:s.province||"",city:s.city||"",barangay:s.barangay||"",street:s.street||"",zip_code:s.zipCode||"",profile_picture:s.profileImage||"",region_id:s.region_id||null,province_id:s.province_id||null,city_id:s.city_id||null,barangay_id:s.barangay_id||null}),localStorage.removeItem("patientVerificationData")}catch{}}},[]);const $=de.useMemo(()=>!Array.isArray(x)||x.length===0?(console.warn("Services is not a valid array:",x),{}):x.reduce((i,s)=>(s&&s.id&&(i[s.id]=s),i),{}),[x]),[D,ne]=d.useState(new Date),ee=()=>{k(!1),E(n)},te=i=>{p(s=>({...typeof s=="object"&&s!==null?s:{},date:i}))},a=i=>{const{name:s,value:c}=i.target;if(s==="phone"){const o=String(c).replace(/[^0-9+]/g,"");p(l=>({...typeof l=="object"&&l!==null?l:{},[s]:o}))}else p(o=>({...typeof o=="object"&&o!==null?o:{},[s]:c}))},u=(i,s)=>{p(c=>({...typeof c=="object"&&c!==null?c:{},[i]:s??null}))},f=(i,s)=>{p(c=>({...typeof c=="object"&&c!==null?c:{},[i]:s}))},[b,ie]=d.useState([]),[he,re]=d.useState([]),oe=de.useMemo(()=>!Array.isArray(b)||b.length===0?{}:b.reduce((i,s)=>(s&&s.id&&(i[s.id]=s),i),{}),[b]),[ue,pe]=d.useState([]);d.useEffect(()=>{const i=$[n.service];pe(i?.servicedays?.map(s=>s.day))},[n,$]);const _=()=>N&&!y,se=()=>N&&!y,xe=()=>!1,ae=async i=>{const s=i.phone?String(i.phone):"",c=i.email?String(i.email):"",o=c&&c.trim()!=="",l=s&&s.trim()!=="";if(!o&&!l){j("Please provide either email or phone number for verification"),window.scrollTo({top:0,behavior:"smooth"});return}q(o?"email":"sms"),L({...i,id:null}),W(!0)},ge=async i=>{console.log("Verification successful! Creating appointment..."),console.log("Pending appointment data:",H),console.log("Verified appointment data from modal:",i),W(!1);try{console.log("Sending appointment creation request...");const s=i||H;console.log("Using appointment data:",s);const c=await fetch(route("patient.appoint.create"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||"",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s)});console.log("Response status:",c.status);const o=await c.json();if(console.log("Appointment creation result after verification:",o),console.log("Priority number from result:",o.priority_number),console.log("Priority number from appointment_data:",o.appointment_data?.priority_number),o.success){console.log("Appointment created successfully! Showing confirmation..."),console.log("Current formData before update:",n),console.log("Result appointment_data:",o.appointment_data),B&&B(!0);const l={...n,...o.appointment_data,id:o.appointment_data.id,priorityNumber:o.appointment_data?.priority_number||o.priority_number||n.priorityNumber||"TEST123",referenceNumber:o.appointment_data.reference_number||o.reference_number||n.referenceNumber,firstname:o.appointment_data?.firstname||n.firstname||"",lastname:o.appointment_data?.lastname||n.lastname||"",middlename:o.appointment_data?.middlename||n.middlename||"",email:o.appointment_data?.email||n.email||"",phone:o.appointment_data?.phone||n.phone||"",gender:o.appointment_data?.gender||n.gender||"",date_of_birth:o.appointment_data?.date_of_birth||n.date_of_birth||"",birth:o.appointment_data?.date_of_birth||n.birth||n.date_of_birth||"",servicename:o.appointment_data?.service_name||n.servicename||"",subservicename:o.appointment_data?.subservice_name||n.subservicename||"",date:o.appointment_data?.date||n.date||"",time:o.appointment_data?.time||n.time||"",notes:o.appointment_data?.notes||n.notes||""};if(console.log("Setting form data with priority number:",l.priorityNumber),console.log("Setting form data with patient data:",{firstname:l.firstname,lastname:l.lastname,email:l.email,phone:l.phone}),console.log("Full new form data:",l),localStorage.setItem("confirmed_appointment_data",JSON.stringify(l)),console.log("Stored appointment data in localStorage:",l),l.email&&l.email.trim()!=="")try{console.log("Sending appointment confirmation email to:",l.email);const le=await(await fetch("/api/sms/send-appointment-email",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({appointment_data:{email:l.email,firstname:l.firstname,lastname:l.lastname,date:l.date,time:l.time,service_name:l.servicename,subservice_name:l.subservicename,priority_number:l.priorityNumber,appointment_id:l.id,phone:l.phone,date_of_birth:l.date_of_birth}})})).json();le.success?(console.log("Appointment confirmation email sent successfully"),window.toast&&window.toast.success("Appointment confirmation email sent successfully!")):(console.warn("Failed to send appointment confirmation email:",le.message),window.toast&&window.toast.warning("Appointment created but email confirmation failed. Please check your email settings."))}catch(C){console.error("Error sending appointment confirmation email:",C),window.toast&&window.toast.error("Appointment created but email confirmation failed. Please contact support if needed.")}else console.log("No email address provided, skipping email confirmation");p(l);const r=new URL(window.location);r.searchParams.set("confirmed","true"),window.history.replaceState({},"",r),window.scrollTo({top:0,behavior:"smooth"})}else console.error("Appointment creation failed:",o),j(o.message||"Failed to create appointment after verification"),window.scrollTo({top:0,behavior:"smooth"})}catch(s){console.error("Error creating appointment after verification:",s),j("An error occurred while creating the appointment. Please try again."),window.scrollTo({top:0,behavior:"smooth"})}},fe=()=>{W(!1),L(null)};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:i=>i.preventDefault(),className:"space-y-6 bg-white p-6 rounded-lg shadow-sm",children:[N&&!y&&e.jsx("div",{className:"bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-5 h-5 text-orange-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-orange-900",children:"Reschedule Appointment"}),e.jsx("p",{className:"text-sm text-orange-700",children:"You are rescheduling your appointment. Personal information and service type are locked. You can change the sub-service, date, and time."})]})]})}),O&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg flex items-start space-x-3",children:[e.jsx("svg",{className:"w-5 h-5 text-red-600 mt-0.5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"font-medium text-sm",children:O})}),e.jsx("button",{onClick:()=>j(""),className:"text-red-600 hover:text-red-800",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),h&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg flex items-start space-x-3",children:[e.jsx("svg",{className:"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm",children:m?"Personal information is locked for authenticated users":"Personal information is locked after verification"}),e.jsx("p",{className:"text-xs mt-1",children:m?"Your account information cannot be modified here":"This information was verified and cannot be changed"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"name",children:"First Name"}),e.jsx(I,{id:"firstname",name:"firstname",value:n.firstname,onChange:a,placeholder:"Your First Name",disabled:h||_(),required:!0}),e.jsx(T,{message:t.firstname})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"middlename",children:"Middle Name"}),e.jsx(I,{id:"middlename",name:"middlename",value:n.middlename,onChange:a,placeholder:"N/A",disabled:h||_(),required:!0}),e.jsx(T,{message:t.middlename})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"lastname",children:"Last Name"}),e.jsx(I,{id:"lastname",name:"lastname",value:n.lastname,onChange:a,placeholder:"Your Last Name",disabled:h||_(),required:!0}),e.jsx(T,{message:t.lastname})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"email",children:"Email Address (Optional)"}),e.jsx(I,{id:"email",name:"email",type:"email",value:n.email,onChange:a,placeholder:"juan@example.com",disabled:h||_()}),e.jsx(T,{message:t.email})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"phone",children:"Phone Number (Optional)"}),e.jsx(I,{id:"phone",name:"phone",type:"tel",value:n.phone,onChange:a,placeholder:"+63 912 345 6789",disabled:h||_()}),e.jsx(T,{message:t.phone})]})]}),e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Additional Patient Information (Optional)"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"This information will be automatically stored in your Patient Record for future appointments"})]}),e.jsx("button",{type:"button",onClick:()=>F(!P),className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:P?"Hide Details":"Show Details"})]}),P&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"date_of_birth",children:"Date of Birth"}),e.jsx(I,{id:"date_of_birth",name:"date_of_birth",type:"date",value:n.date_of_birth,onChange:a,disabled:h||_()})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"gender",children:"Gender"}),e.jsxs(J,{value:n.gender,onValueChange:i=>f("gender",i),disabled:h||_(),children:[e.jsx(Y,{children:e.jsx(U,{placeholder:"Select gender"})}),e.jsxs(X,{children:[e.jsx(S,{value:"Male",children:"Male"}),e.jsx(S,{value:"Female",children:"Female"}),e.jsx(S,{value:"Other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"civil_status",children:"Civil Status"}),e.jsxs(J,{value:n.civil_status,onValueChange:i=>f("civil_status",i),disabled:h||_(),children:[e.jsx(Y,{children:e.jsx(U,{placeholder:"Select status"})}),e.jsxs(X,{children:[e.jsx(S,{value:"Single",children:"Single"}),e.jsx(S,{value:"Married",children:"Married"}),e.jsx(S,{value:"Widowed",children:"Widowed"}),e.jsx(S,{value:"Divorced",children:"Divorced"}),e.jsx(S,{value:"Separated",children:"Separated"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"nationality",children:"Nationality"}),e.jsx(I,{id:"nationality",name:"nationality",value:n.nationality,onChange:a,placeholder:"e.g., Filipino",disabled:h||_()})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"religion",children:"Religion"}),e.jsx(I,{id:"religion",name:"religion",value:n.religion,onChange:a,placeholder:"e.g., Catholic",disabled:h||_()})]})]}),e.jsx(ve,{formData:n,setFormData:p,isDisabled:h||_(),showStreet:!0,showZipCode:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Service Type"}),e.jsxs(J,{value:n.service?.toString(),onValueChange:i=>{if(se())return;const s=$[i];s&&(u("service",s.id),u("servicename",s.servicename),u("date",null),u("subservice",""),u("subservicename",""),u("timeid",""),u("time","")),fetch(`/services/get-sub-services/${i}`).then(c=>c.json()).then(c=>{ie(c)})},disabled:se(),children:[e.jsx(Y,{className:"w-full",children:e.jsx(U,{placeholder:"Select service",children:n.service?(x||[]).find(i=>i.id.toString()===n.service.toString())?.servicename:"Select service"})}),e.jsx(X,{children:(x||[]).map(i=>e.jsx(S,{value:i.id,children:i.servicename},i.id))})]}),e.jsx(T,{message:t.service})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Service Sub Type"}),e.jsxs(J,{value:n.subservice?.toString(),onValueChange:i=>{if(se())return;const s=oe[i];re(s?.times),u("subservice",s.id??null),u("subservicename",s.subservicename??null),u("timeid",""),u("time","")},disabled:se(),children:[e.jsx(Y,{className:"w-full",children:e.jsx(U,{placeholder:"Select Sub Service",children:n.subservice?b.find(i=>i.id.toString()===n.subservice.toString())?.subservicename:"Select Sub-Service"})}),e.jsx(X,{children:b?.map((i,s)=>e.jsx(S,{value:i.id,children:i.subservicename},s))})]}),e.jsx(T,{message:t.subservice})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Appointment Date"}),e.jsx(be,{selectedDate:n.date,onDateSelect:te,hasPrograms:ue,serviceId:n.service,subserviceId:n.subservice}),e.jsx(T,{message:t.date})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Appointment Time"}),e.jsxs(J,{value:n.timeid,onValueChange:i=>{const s=oe[n.subservice];u("timeid",i??null),u("time",G(s?.times?.find(c=>c.id==i)?.time,"HH:mm:ss").format("hh:mm A")??null)},disabled:xe(),children:[e.jsx(Y,{className:"w-full",children:e.jsx(U,{placeholder:"Select time",children:n.timeid?e.jsxs("div",{className:"flex items-center",children:[e.jsx(_e,{className:"mr-2 h-4 w-4"}),G(n.time,"HH:mm:ss").format("h:mm A")]}):"Select time"})}),e.jsx(X,{children:he.map((i,s)=>e.jsx(S,{value:i.id,children:G(i.time,"HH:mm:ss").format("h:mm A")},i.id))})]}),e.jsx(T,{message:t.time})]})]})]}),e.jsx("div",{className:"space-y-4",children:ce().props.auth.user&&!y?e.jsx(V,{onClick:i=>{i.preventDefault(),i.stopPropagation();const c=["firstname","lastname","service","date","time"].filter(o=>!n[o]||n[o].toString().trim()==="");if(c.length>0){const o={firstname:"First Name",lastname:"Last Name",service:"Service Type",date:"Appointment Date",time:"Appointment Time"},l=c.map(r=>o[r]||r);j(`Please fill in the following required fields: ${l.join(", ")}`),window.scrollTo({top:0,behavior:"smooth"});return}j(""),E(n)},disabled:R,className:"w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105",children:R?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{className:"animate-spin w-5 h-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Processing..."})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("span",{children:N&&!y?"Reschedule Appointment":"Schedule Appointment"})]})}):y?e.jsx(V,{onClick:i=>{i.preventDefault(),i.stopPropagation();const c=["firstname","lastname","service","date","time"].filter(o=>!n[o]||n[o].toString().trim()==="");if(c.length>0){const o={firstname:"First Name",lastname:"Last Name",service:"Service Type",date:"Appointment Date",time:"Appointment Time"},l=c.map(r=>o[r]||r);j(`Please fill in the following required fields: ${l.join(", ")}`),window.scrollTo({top:0,behavior:"smooth"});return}j(""),ae(n)},disabled:R,className:"w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105",children:R?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{className:"animate-spin w-5 h-5",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Processing..."})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:"Book New Appointment"})]})}):e.jsx("div",{className:"text-center space-y-4",children:e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6",children:[e.jsx("div",{className:"flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Ready to Book Your Appointment?"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Complete your patient verification to access appointment booking and manage your health records."}),e.jsx(V,{onClick:i=>{i.preventDefault(),i.stopPropagation();const c=["firstname","lastname","service","date","time"].filter(o=>!n[o]||n[o].toString().trim()==="");if(c.length>0){const o={firstname:"First Name",lastname:"Last Name",service:"Service Type",date:"Appointment Date",time:"Appointment Time"},l=c.map(r=>o[r]||r);j(`Please fill in the following required fields: ${l.join(", ")}`),window.scrollTo({top:0,behavior:"smooth"});return}j(""),ae(n)},className:"w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("span",{children:"Appoint Now!"})]})})]})})})]}),e.jsx(Se,{isOpen:K,onClose:()=>k(!1),onConfirm:ee,title:"Confirmation",message:"Are you sure you want to confirm this appointment?",confirmText:"Confirm",cancelText:"Cancel"}),e.jsx(Ce,{isOpen:Z,onClose:fe,onVerified:ge,appointmentData:H,verificationMethod:Q})]})};export{oi as default};
