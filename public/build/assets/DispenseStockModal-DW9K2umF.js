import{r as d,P as Oe,j as e}from"./app-CNLcV3Uy.js";import{D as O,a as U,b as R,c as Q,e as ce,d as H}from"./dialog-DVfT_V8C.js";import{B as f}from"./button-sKrKyyfs.js";import{I}from"./input-DwwFRcXc.js";import{L as N}from"./label-NZo9JiVO.js";import{T as Ue}from"./textarea-jcbswd-T.js";import"./select-Bp0DYyHk.js";import{P as k}from"./package-DILRBpjw.js";import{Z as Re}from"./zap-BZUGl1rl.js";import{F as G}from"./file-text-DBglxC-6.js";import{m as A}from"./proxy-BaA_RYOF.js";import{H as Qe}from"./hash-ClIj3HX8.js";import{T as He}from"./triangle-alert-Dcp2x8pu.js";import{C as oe}from"./calendar-Cuf42Q_b.js";import{C as le}from"./circle-check-big-Zb2g8Xok.js";import"./Combination-ISuQ_xQH.js";import"./index-CRjh3eQV.js";import"./utils-Cdwu_oFC.js";import"./index-CY8IRa4h.js";import"./index-5XPp9efM.js";import"./index-BmPn7Lwa.js";import"./index--okc8Vo6.js";import"./index-DCywbQWC.js";import"./createLucideIcon-N6tzm2Un.js";const Ns=({open:y,onClose:S,item:a})=>{const[M,$]=d.useState([]),[r,J]=d.useState(null),[j,g]=d.useState({}),[h,D]=d.useState("prescription"),[W,w]=d.useState([]),[l,X]=d.useState(null),[Ge,K]=d.useState([]),[Je,V]=d.useState([]),[We,T]=d.useState([]),[de,Z]=d.useState(!1),[q,z]=d.useState(!1),[Xe,Y]=d.useState(!1),[Ke,me]=d.useState([]),[Ve,pe]=d.useState({}),[ee,P]=d.useState(!1),[c,L]=d.useState(null),[ue,se]=d.useState(a?.quantity||0),[te,C]=d.useState(!1),[ne,B]=d.useState(!1),[p,ae]=d.useState(null),{data:o,setData:x,post:he,processing:_}=Oe({item_id:a?.id||"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:"",prescription_id:"",patient_id:"",doctor_id:""}),ie=s=>{const t=new Date;return s.filter(n=>{if(!n.expiry_date||n.expiry_date==="N/A"||n.expiry_date==="Invalid Date")return!0;try{return new Date(n.expiry_date)>=t}catch{return console.warn("Invalid expiry date format:",n.expiry_date),!0}})},E=async()=>{if(!(!a||!y)){z(!0);try{let s=[];if(a.batches&&Array.isArray(a.batches)&&a.batches.length>0)s=a.batches.map(n=>({batch_number:n.batchNumber||"N/A",expiry_date:n.expiryDate||"N/A",available_quantity:n.quantity||0,location:n.storageLocation||"N/A",batch_id:n.id})),console.log("Loaded grouped batches:",s);else{const n=await fetch(route("pharmacist.inventory.item.batches",a.id));n.ok?(s=await n.json(),console.log("Loaded API batches:",s)):(console.error("Failed to load batches:",n.statusText),s=[{batch_number:a.batchNumber||a.batch_number||"N/A",expiry_date:a.expiryDate||a.expiry_date||"N/A",available_quantity:a.quantity||a.totalQuantity||0,location:a.storageLocation||a.storage_location||"N/A",batch_id:a.id}])}const t=ie(s);$(t),console.log("Filtered batches (expired removed):",t)}catch(s){console.error("Error loading batches:",s);const t=[{batch_number:a.batchNumber||a.batch_number||"N/A",expiry_date:a.expiryDate||a.expiry_date||"N/A",available_quantity:a.quantity||a.totalQuantity||0,location:a.storageLocation||a.storage_location||"N/A",batch_id:a.id}],n=ie(t);$(n)}finally{z(!1)}}};d.useEffect(()=>{a&&y&&(console.log("Modal opened, resetting to prescription mode"),E(),x("item_id",a.id),x("dispensed_by","Current User"),se(a.quantity||0),D("prescription"))},[a,y]),d.useEffect(()=>{console.log("Dispense mode changed to:",h)},[h]),d.useEffect(()=>{if(y&&window.Echo)return window.Echo.channel("inventory-updates").listen("InventoryUpdated",s=>{console.log("Inventory updated, refreshing batch data...",s),E()}),()=>{window.Echo.leaveChannel("inventory-updates")}},[y]);const xe=async()=>{console.log("Loading pending prescriptions..."),Z(!0);try{const s=route("pharmacist.prescriptions.pending");console.log("Fetching from URL:",s);const t=await fetch(s);if(console.log("Response status:",t.status),console.log("Response headers:",Object.fromEntries(t.headers.entries())),!t.ok){console.error("Failed to load prescriptions:",t.status,t.statusText),w([]);return}const n=t.headers.get("content-type");if(!n||!n.includes("application/json")){console.error("Invalid response format:",n),w([]);return}const i=await t.json();console.log("Loaded prescriptions:",i),console.log("Number of prescriptions:",i.length),w(i)}catch(s){console.error("Error loading prescriptions:",s),w([])}finally{Z(!1)}},ge=async()=>{try{const s=await fetch(route("pharmacist.patients-doctors"));if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=s.headers.get("content-type");if(!t||!t.includes("application/json")){const i=await s.text();throw console.error("Expected JSON but got:",i),new Error("Server returned non-JSON response")}const n=await s.json();K(n.patients||[]),V(n.doctors||[])}catch(s){console.error("Error loading patients and doctors:",s),K([]),V([])}},be=async()=>{Y(!0);try{const s=await fetch(route("pharmacist.case-ids"));if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const t=s.headers.get("content-type");if(!t||!t.includes("application/json")){const i=await s.text();throw console.error("Expected JSON but got:",i),new Error("Server returned non-JSON response")}const n=await s.json();console.log("Loaded available Case IDs:",n),T(n.case_ids||[])}catch(s){console.error("Error loading available Case IDs:",s),T([])}finally{Y(!1)}};d.useEffect(()=>{y&&(ge(),be(),xe())},[y]);const ye=s=>{J(s),x("batch_id",s.batch_id||s.id),x("batch_number",s.batch_number),x("quantity",""),g({})},je=()=>{const s={};return o.prescription_id||(s.prescription="Please select a prescription"),o.batch_number||(s.batch_number="Please select a batch"),g(s),Object.keys(s).length===0},fe=s=>{X(s),x("prescription_id",s.id),x("patient_name",s.patient_name),x("patient_id",s.patient_id),x("doctor_id",s.doctor_id),x("case_id",s.case_id||s.prescription_number),x("reason","Prescription Dispensing")},Ne=()=>{if(!l)return g({prescription:"Please select a prescription"}),!1;if(!r)return g({batch_number:"Please select a batch"}),!1;if(!l.medicines?.some(i=>i.medicine_id===a.id))return g({prescription:"This prescription does not contain the selected item"}),!1;const t=l.medicines.filter(i=>i.medicine_id===a.id).reduce((i,m)=>i+(m.quantity||0),0),n=r.available_quantity||0;return t>n?(g({batch_number:`Insufficient stock in selected batch. Required: ${t}, Available: ${n}`}),!1):!0},_e=(s,t)=>{const n=s.medicines.find(v=>v.medicine_id===a.id),i=t.reduce((v,Fe)=>v+Fe.quantity,0),m=()=>n?.medicine_name&&n.medicine_name!=="Unknown Medicine"?n.medicine_name:a?.name?a.name:"Medicine",b={name:m(),generic_name:a?.generic_name||a?.name||"Generic",unit:a?.unit||"units",manufacturer:a?.manufacturer||"Unknown Manufacturer"};return{prescription_number:s.prescription_number,patient_name:s.patient_name,doctor_name:s.doctor_name,medicine_name:b.name,medicine_generic:b.generic_name,medicine_unit:b.unit,medicine_manufacturer:b.manufacturer,required_quantity:n?.quantity||0,dispensed_quantity:i,batches_used:t.length,expiry_dates:t.map(v=>v.expiry_date),allocated_batches:t}},ve=()=>{if(!je()||!Ne())return;const t=l.medicines.find(m=>m.medicine_id===a.id)?.quantity||0,n=[{batch_id:r.batch_id||r.id,batch_number:r.batch_number,quantity:Math.min(t,r.available_quantity),expiry_date:r.expiry_date}],i=_e(l,n);L(i),P(!0)},Se=(s,t,n)=>{console.log("Executing post-dispense functions for transaction:",s),De(s,t),qe(s,t,"completed"),Pe(s,t),Ce(l.id,"dispensed"),Ee(s,t,"dispense_completed"),Ie(a.id),ke(s,t),we(),console.log("Post-dispense functions completed for transaction:",s)},De=(s,t)=>{console.log("Updating stock quantities for transaction:",s),t.allocated_batches.forEach(i=>{console.log(`Updating batch ${i.batch_number}: -${i.quantity} units`),$(m=>m.map(u=>u.batch_number===i.batch_number?{...u,available_quantity:Math.max(0,u.available_quantity-i.quantity),dispensed_quantity:(u.dispensed_quantity||0)+i.quantity}:u))});const n=t.allocated_batches.reduce((i,m)=>i+m.quantity,0);console.log(`Total dispensed: ${n} units from item ${a.name}`),se(i=>{const m=Math.max(0,i-n);return console.log(`Stock updated: ${i} - ${n} = ${m}`),m})},we=()=>{console.log("Refreshing inventory data..."),E(),window.Echo&&window.Echo.channel("inventory-updates").trigger("InventoryUpdated",{type:"stock_updated",item_id:a.id,action:"dispense"})},qe=(s,t,n)=>{const i={transaction_id:s,action:"dispense",status:n,patient_name:t.patient_name,prescription_number:t.prescription_number,medicine_name:t.medicine_name,quantity:t.dispensed_quantity,batches_used:t.batches_used,timestamp:new Date().toISOString(),user:"pharmacist"};console.log("Dispense activity logged:",i)},Pe=(s,t)=>{const n={type:"dispense_completed",title:"Medicine Dispensed Successfully",message:`Prescription ${t.prescription_number} has been dispensed for ${t.patient_name}`,transaction_id:s,patient_name:t.patient_name,medicine_name:t.medicine_name,quantity:t.dispensed_quantity,timestamp:new Date().toISOString()};console.log("Dispense notification:",n)},Ce=(s,t)=>{console.log(`Updating prescription ${s} status to: ${t}`)},Ee=(s,t,n)=>{const i={transaction_id:s,action:n,entity_type:"prescription",entity_id:l.id,changes:{status:"dispensed",dispensed_at:new Date().toISOString(),dispensed_by:"pharmacist",dispensed_quantity:t.dispensed_quantity,batches_used:t.batches_used},timestamp:new Date().toISOString(),user:"pharmacist"};console.log("Audit trail entry created:",i)},Ie=s=>{console.log(`Checking low stock alerts for item: ${s}`)},ke=(s,t)=>{const n={transaction_id:s,prescription_number:t.prescription_number,patient_name:t.patient_name,doctor_name:t.doctor_name,medicine_name:t.medicine_name,quantity:t.dispensed_quantity,batches:t.allocated_batches,dispensed_at:new Date().toISOString(),dispensed_by:"pharmacist"};console.log("Dispense receipt generated:",n)},Ae=async()=>{if(console.log("Confirm Dispense started"),console.log("Preview data:",c),console.log("Selected prescription:",l),console.log("Selected batch:",r),console.log("Selected batch ID:",r?.batch_id||r?.id),console.log("Selected batch number:",r?.batch_number),console.log("Item:",a),!c){console.error("No preview data available!"),alert("Error: No preview data available. Please try again.");return}if(!l){console.error("No prescription selected!"),alert("Error: No prescription selected. Please select a prescription first.");return}if(!r){console.error("No batch selected!"),alert("Error: No batch selected. Please select a batch first.");return}const s=`DISP-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;console.log("Generated transaction ID:",s);const t={prescription_id:l.id,dispensed_by:"pharmacist",batch_id:String(r?.batch_id||r?.id||""),batch_number:r?.batch_number,item_id:a.id};C(!0),console.log("Sending dispense data:",t);let n;try{n=route("pharmacist.prescriptions.auto-dispense")}catch(i){console.error("Route helper failed:",i),n="/pharmacist/inventory/prescriptions/auto-dispense"}try{console.log("Making API call...");const i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(t)});if(i.ok){const m=await i.json();console.log("Dispense completed successfully:",m);const u=m.dispense_summary||{};console.log("Dispense summary from backend:",u);const b={transactionId:u.transaction_id||s,timestamp:new Date().toLocaleString(),prescription:{number:c.prescription_number,caseId:c.case_id||"N/A"},patient:{name:c.patient_name,id:u.patient?.id||"N/A"},doctor:{name:c.doctor_name,id:u.doctor?.id||"N/A"},medicine:{name:c.medicine_name,generic:c.medicine_generic,manufacturer:c.medicine_manufacturer,quantity:c.dispensed_quantity,unit:c.medicine_unit},batch:{number:r?.batch_number||"N/A",expiration:r?.expiration_date||"N/A"},summary:{totalItems:u.summary?.total_items||1,totalQuantity:u.summary?.total_quantity||c.dispensed_quantity,inventoryImpact:u.inventory_impact?.items_affected||1},pharmacist:{name:u.pharmacist?.name||"Current User",id:u.pharmacist?.id||"N/A"}};ae(b),B(!0),S(),re(),P(!1),L(null),C(!1),Se(b.transactionId,c,b),window.Echo&&window.Echo.channel("inventory-updates").trigger("InventoryUpdated",{type:"dispense",item_id:a.id,quantity:c.dispensed_quantity,transaction_id:s})}else{const m=await i.json();console.error("Auto-dispense error:",m),g(m),C(!1);const u={transactionId:s,prescription:c.prescription_number,patient:c.patient_name,medicine:c.medicine_name,error:m,timestamp:new Date().toLocaleString(),status:"failed"};console.log("Dispense error summary:",u);const b=`âŒ Dispense Failed!

ðŸ“‹ Transaction ID: ${s}
ðŸ‘¤ Patient: ${c.patient_name}
ðŸ’Š Medicine: ${c.medicine_name}
ðŸ·ï¸ Generic: ${c.medicine_generic}
ðŸ­ Manufacturer: ${c.medicine_manufacturer}
âŒ Error: ${Object.values(m).join(", ")}
â° Time: ${new Date().toLocaleString()}`;alert(b)}}catch(i){console.error("Network error during dispense:",i),C(!1);const m=`âŒ Network Error!

ðŸ“‹ Transaction ID: ${s}
ðŸ‘¤ Patient: ${c.patient_name}
ðŸ’Š Medicine: ${c.medicine_name}
âŒ Error: ${i.message}
â° Time: ${new Date().toLocaleString()}`;alert(m)}console.log("Confirm Dispense completed")},Me=()=>{const s={};return r||(s.batch_number="Please select a batch"),l||(s.prescription="Please select a prescription"),s},$e=()=>{const s={};return r||(s.batch_number="Please select a batch"),(!o.quantity||o.quantity<=0)&&(s.quantity="Please enter a valid quantity"),o.reason||(s.reason="Please enter a reason for dispensing"),s},Te=s=>{s.preventDefault(),console.log("=== FORM SUBMITTED ==="),console.log("Form submitted, mode:",h),console.log("Selected batch:",r),console.log("Selected prescription:",l),console.log("Form data:",o);let t={};if(h==="prescription"?t=Me():h==="manual"&&(t=$e()),console.log("Validation errors:",t),Object.keys(t).length>0){g(t);return}g({}),h==="prescription"?(console.log("Calling previewDispense"),ve()):(console.log("Calling handleManualDispense"),Le())},Le=()=>{if(console.log("=== MANUAL DISPENSE STARTED ==="),console.log("Selected batch:",r),console.log("Quantity:",o.quantity),console.log("Reason:",o.reason),console.log("Patient name:",o.patient_name),console.log("Case ID:",o.case_id),console.log("Notes:",o.notes),!r){console.error("No batch selected"),g({batch_number:"Please select a batch"});return}if(!o.quantity||o.quantity<=0){console.error("Invalid quantity"),g({quantity:"Please enter a valid quantity"});return}if(!o.reason){console.error("No reason provided"),g({reason:"Please enter a reason for dispensing"});return}const s={item_id:a.id,batch_id:r.batch_id||r.id,batch_number:r.batch_number,quantity:parseInt(o.quantity),reason:o.reason,patient_name:o.patient_name||"Manual Dispense",case_id:o.case_id||null,dispensed_by:o.dispensed_by||"Current User",notes:o.notes||`Manual dispense - ${o.reason}`,dispense_mode:"manual"};console.log("Dispense data prepared:",s),console.log("Submitting to route:",route("pharmacist.inventory.dispense")),he(route("pharmacist.inventory.dispense"),s,{onSuccess:()=>{console.log("=== MANUAL DISPENSE SUCCESSFUL ==="),S(),re(),window.location.reload()},onError:t=>{console.error("=== MANUAL DISPENSE ERROR ===",t),g(t)}})},re=()=>{x({item_id:"",batch_id:"",batch_number:"",quantity:"",reason:"",patient_name:"",case_id:"",dispensed_by:"",notes:"",prescription_id:"",patient_id:"",doctor_id:""}),J(null),X(null),me([]),pe({}),g({}),D("prescription"),T([])},F=s=>s?new Date(s).toLocaleDateString():"N/A",Be=s=>{if(!s)return!1;const t=new Date(s);return Math.ceil((t-new Date)/(1e3*60*60*24))<=30};return a?e.jsxs(e.Fragment,{children:[e.jsx(O,{open:y,onOpenChange:S,children:e.jsxs(U,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(R,{children:[e.jsxs(Q,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),"Dispense Stock - ",a.name]}),e.jsx(ce,{children:h==="prescription"?"Select a prescription to automatically dispense the required medicines from available stock.":"Select a batch and enter dispensing details to dispense stock from inventory."})]}),e.jsxs("form",{onSubmit:Te,className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-2 flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5"}),"Stock Dispense"]}),e.jsx("p",{className:"text-sm text-gray-600",children:h==="prescription"?"Choose how you want to dispense this item from inventory.":"Enter the details for manual dispensing of this item."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 mb-3",children:["Dispense Mode (Current: ",h,")"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>{console.log("Switching to prescription mode"),D("prescription")},className:`p-3 border rounded-lg text-left transition-all ${h==="prescription"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Prescription Based"})]}),e.jsx("p",{className:"text-xs text-gray-600",children:"Dispense based on existing prescriptions"})]}),e.jsxs("button",{type:"button",onClick:()=>{console.log("Switching to manual mode"),D("manual")},className:`p-3 border rounded-lg text-left transition-all ${h==="manual"?"border-blue-500 bg-blue-50 text-blue-700":"border-gray-200 hover:border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"Manual Dispense"})]}),e.jsx("p",{className:"text-xs text-gray-600",children:"Dispense directly without prescription"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Item Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.manufacturer||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.category?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Stock:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[ue," ",a.unit_type||"units"]})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs(N,{className:"text-sm font-medium",children:["Available Batches for ",a.name]}),e.jsxs(f,{type:"button",variant:"outline",size:"sm",onClick:E,disabled:q,className:"flex items-center gap-1",children:[e.jsx(k,{className:`h-3 w-3 ${q?"animate-spin":""}`}),q?"Loading...":"Refresh"]})]}),e.jsx("div",{className:"mt-2 space-y-2",children:q&&M.length===0?e.jsxs("div",{className:"flex items-center justify-center py-4 text-gray-500",children:[e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}),"Loading available batches..."]}):M.length===0?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"No batches available for this item"}):M.map((s,t)=>e.jsx(A.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:t*.1},className:`p-3 border rounded-lg cursor-pointer transition-all ${r?.batch_number===s.batch_number?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>ye(s),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${r?.batch_number===s.batch_number?"bg-blue-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:s.batch_number}),Be(s.expiry_date)&&e.jsx(He,{className:"h-4 w-4 text-amber-500"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Available: ",s.available_quantity," units"]})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-4 w-4"}),F(s.expiry_date)]}),e.jsx("div",{className:"text-xs text-gray-500",children:s.location})]})]})},s.batch_number))}),j.batch_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:j.batch_number})]}),h==="prescription"&&e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"Select Prescription"}),de?e.jsx("div",{className:"mt-2 p-4 text-center text-gray-500",children:"Loading prescriptions..."}):e.jsx("div",{className:"mt-2 space-y-2 max-h-60 overflow-y-auto",children:W.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No pending prescriptions found"}):W.map((s,t)=>e.jsxs(A.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:t*.1},className:`p-3 border rounded-lg cursor-pointer transition-all ${l?.id===s.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>fe(s),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${l?.id===s.id?"bg-blue-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:s.prescription_number})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Patient: ",s.patient_name]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Doctor: ",s.doctor_name]}),e.jsxs("div",{className:"text-sm text-blue-600 font-medium",children:["Case ID: ",s.case_id||"N/A"]})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-4 w-4"}),F(s.prescription_date)]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.medicines.length," medicines"]})]})]}),l?.id===s.id&&e.jsxs(A.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-3 pt-3 border-t border-gray-200",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Medicines in Prescription:"}),e.jsx("div",{className:"space-y-2",children:s.medicines.map((n,i)=>e.jsx("div",{className:"bg-white p-2 rounded border text-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:n.medicine_name}),e.jsxs("div",{className:"text-gray-600",children:["Quantity: ",n.quantity," | Dosage: ",n.dosage]}),e.jsxs("div",{className:"text-gray-600",children:["Frequency: ",n.frequency," | Duration: ",n.duration]}),n.instructions&&e.jsxs("div",{className:"text-gray-600",children:["Instructions: ",n.instructions]})]}),n.is_dispensed&&e.jsx(le,{className:"h-4 w-4 text-green-500"})]})},i))})]})]},s.id))}),j.prescription&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:j.prescription})]}),h==="manual"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"quantity",children:"Quantity to Dispense *"}),e.jsx(I,{id:"quantity",type:"number",min:"1",value:o.quantity,onChange:s=>x("quantity",s.target.value),placeholder:"Enter quantity to dispense",className:"mt-1"}),j.quantity&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:j.quantity})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"reason",children:"Reason for Dispensing *"}),e.jsx(I,{id:"reason",value:o.reason,onChange:s=>x("reason",s.target.value),placeholder:"e.g., Emergency use, Over-the-counter, etc.",className:"mt-1"}),j.reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:j.reason})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"patient_name",children:"Patient/Recipient Name"}),e.jsx(I,{id:"patient_name",value:o.patient_name,onChange:s=>x("patient_name",s.target.value),placeholder:"Enter patient or recipient name (optional)",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"case_id",children:"Case ID"}),e.jsx(I,{id:"case_id",value:o.case_id,onChange:s=>x("case_id",s.target.value),placeholder:"Enter case ID (optional)",className:"mt-1"})]})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"notes",children:"Additional Notes"}),e.jsx(Ue,{id:"notes",value:o.notes,onChange:s=>x("notes",s.target.value),placeholder:"Any additional notes or instructions...",className:"mt-1",rows:3})]}),l&&r&&e.jsxs(A.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-semibold text-blue-900 mb-2 flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),"Dispense Summary"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:a.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Batch:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.batch_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Available Quantity:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[r.available_quantity," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Expiry Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:F(r.expiry_date)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Patient:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.patient_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Case ID:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.case_id||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Doctor:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.doctor_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700",children:"Prescription:"}),e.jsx("span",{className:"ml-2 font-medium",children:l.prescription_number})]})]})]}),e.jsxs(H,{children:[e.jsx(f,{type:"button",variant:"outline",onClick:S,disabled:_,children:"Cancel"}),e.jsx(f,{type:"submit",disabled:_||!r||h==="prescription"&&!l,style:{backgroundColor:"#2C3E50"},onClick:s=>{console.log("=== BUTTON CLICKED ==="),console.log("Button type:",s.target.type),console.log("Form element:",s.target.closest("form")),console.log("Dispense mode:",h),console.log("Selected batch:",r),console.log("Form data:",o),console.log("Button disabled:",_||!r||h==="prescription"&&!l),console.log("Processing:",_),console.log("Selected batch exists:",!!r),console.log("Prescription mode check:",h==="prescription"&&!l)},children:_?"Stock Dispensing...":"Stock Dispense"})]})]})]})}),ee&&c&&e.jsx(O,{open:ee,onOpenChange:P,children:e.jsxs(U,{className:"max-w-2xl",children:[e.jsxs(R,{children:[e.jsxs(Q,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5"}),"Dispense Preview"]}),e.jsx(ce,{children:"Review the dispense details before confirming"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-3",children:"Prescription Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Prescription:"}),e.jsx("span",{className:"ml-2",children:c.prescription_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Patient:"}),e.jsx("span",{className:"ml-2",children:c.patient_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Doctor:"}),e.jsx("span",{className:"ml-2",children:c.doctor_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Medicine:"}),e.jsx("span",{className:"ml-2",children:c.medicine_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Generic Name:"}),e.jsx("span",{className:"ml-2",children:c.medicine_generic})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-700 font-medium",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2",children:c.medicine_manufacturer})]})]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-green-900 mb-3",children:"Dispense Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700 font-medium",children:"Required Quantity:"}),e.jsxs("span",{className:"ml-2",children:[c.required_quantity," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700 font-medium",children:"Will Dispense:"}),e.jsxs("span",{className:"ml-2 font-bold text-green-800",children:[c.dispensed_quantity," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700 font-medium",children:"Batches Used:"}),e.jsxs("span",{className:"ml-2",children:[c.batches_used," batches"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-green-700 font-medium",children:"Status:"}),e.jsx("span",{className:"ml-2",children:c.required_quantity===c.dispensed_quantity?e.jsx("span",{className:"text-green-600 font-medium",children:"âœ“ Complete"}):e.jsx("span",{className:"text-orange-600 font-medium",children:"âš  Partial"})})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Batch Allocation"}),e.jsx("div",{className:"space-y-2",children:c.allocated_batches.map((s,t)=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-white rounded border",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:s.batch_number}),e.jsxs("span",{className:"text-gray-500 ml-2",children:["(",new Date(s.expiry_date).toLocaleDateString(),")"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"font-bold text-blue-600",children:[s.quantity," units"]})})]},t))})]})]}),e.jsxs(H,{children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>{P(!1),L(null)},children:"Cancel"}),e.jsx(f,{type:"button",onClick:Ae,disabled:te||!l||!r,className:"bg-green-600 hover:bg-green-700",children:te?"Processing...":"Confirm Dispense"})]})]})}),ne&&p&&e.jsx(O,{open:ne,onOpenChange:B,children:e.jsxs(U,{className:"max-w-2xl",children:[e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsxs("div",{children:[e.jsx(Q,{className:"text-2xl font-bold text-green-600",children:"Dispense Completed Successfully!"}),e.jsx("p",{className:"text-gray-600",children:"Transaction Summary"})]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-gray-800",children:"Transaction Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Transaction ID:"}),e.jsx("p",{className:"font-mono text-sm font-semibold",children:p.transactionId})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Date & Time:"}),e.jsx("p",{className:"text-sm font-semibold",children:p.timestamp})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-blue-800",children:"Prescription Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-blue-600",children:"Prescription Number:"}),e.jsx("p",{className:"font-semibold",children:p.prescription.number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-blue-600",children:"Case ID:"}),e.jsx("p",{className:"font-semibold",children:p.prescription.caseId})]})]})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-purple-800",children:"Patient Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-purple-600",children:"Patient Name:"}),e.jsx("p",{className:"font-semibold",children:p.patient.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-purple-600",children:"Patient ID:"}),e.jsx("p",{className:"font-semibold",children:p.patient.id})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-green-800",children:"Medicine Details"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-green-600",children:"Medicine Name:"}),e.jsx("p",{className:"font-semibold",children:p.medicine.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-green-600",children:"Generic Name:"}),e.jsx("p",{className:"font-semibold",children:p.medicine.generic})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-green-600",children:"Manufacturer:"}),e.jsx("p",{className:"font-semibold",children:p.medicine.manufacturer})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-green-600",children:"Quantity Dispensed:"}),e.jsxs("p",{className:"font-semibold text-lg",children:[p.medicine.quantity," ",p.medicine.unit]})]})]})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-orange-800",children:"Batch Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-orange-600",children:"Batch Number:"}),e.jsx("p",{className:"font-semibold",children:p.batch.number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-orange-600",children:"Expiration Date:"}),e.jsx("p",{className:"font-semibold",children:p.batch.expiration})]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-gray-800",children:"Staff Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Prescribing Doctor:"}),e.jsx("p",{className:"font-semibold",children:p.doctor.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Dispensing Pharmacist:"}),e.jsx("p",{className:"font-semibold",children:p.pharmacist.name})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border-2 border-blue-200",children:[e.jsx("h3",{className:"font-semibold text-lg mb-3 text-gray-800",children:"Dispense Summary"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:p.summary.totalItems}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Items"})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:p.summary.totalQuantity}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Quantity"})]}),e.jsxs("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:p.summary.inventoryImpact}),e.jsx("div",{className:"text-sm text-gray-600",children:"Inventory Impact"})]})]})]})]}),e.jsxs(H,{className:"flex gap-3",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>{B(!1),ae(null)},children:"Close"}),e.jsx(f,{type:"button",onClick:()=>{window.print()},className:"bg-blue-600 hover:bg-blue-700",children:"Print Summary"}),e.jsx(f,{type:"button",onClick:()=>{alert("Export functionality will be implemented soon!")},className:"bg-green-600 hover:bg-green-700",children:"Export PDF"})]})]})})]}):null};export{Ns as default};
