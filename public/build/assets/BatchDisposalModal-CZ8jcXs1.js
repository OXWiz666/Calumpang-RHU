import{u as ie,j as e,r as E}from"./app-Jdp7iNzl.js";import{r as h}from"./vendor-DkBadjUr.js";import{D as le,a as oe,b as de,c as ne,d as re}from"./dialog-Dbk7O2i8.js";import{B as S}from"./button-bex_LU9I.js";import{I as A}from"./input-NCJ_n0W_.js";import{L as u}from"./label-CGwfsoC9.js";import{T as ce}from"./textarea-hvcYZMC6.js";import{t as _,a as L}from"./toast-CW2_iv-L.js";import{S as k,a as P,b as F,c as O,d as T}from"./select-CspDrWdj.js";import{T as H}from"./trash-2-DJ5zXW8D.js";import{H as X}from"./hash-AgYeaIxt.js";import{C as me}from"./calendar-D9APQM2e.js";import{m as pe}from"./proxy-FTaFPFFz.js";import{C as ue}from"./circle-x-Cf2XhiVO.js";import{T as he}from"./triangle-alert-BslwqqvL.js";import{C as xe}from"./circle-check-big-BQVCuGNJ.js";import"./pusher-DVtoYAOu.js";import"./react-icons.esm-DopY43hH.js";import"./index-C03ciVM9.js";import"./index-CnT-AOMH.js";import"./tslib.es6-M_FJ09fS.js";import"./index-lVX1eI0n.js";import"./use-toast-Dm0PN6fH.js";import"./refresh-cw-D3hZ7e_O.js";import"./createLucideIcon-BKWaAi2G.js";import"./save-CAdd64LS.js";import"./square-pen-Bb1JtfBr.js";import"./download-BH8XyxCx.js";import"./archive-BwGVl8jP.js";import"./info-BVLwYIm5.js";import"./circle-check-F3PuHnLX.js";import"./index-B2TPyuzg.js";import"./index-CQJFG6sX.js";import"./index-BhA1pP3R.js";import"./index-at3TdkEY.js";import"./index-DqxisvwK.js";import"./index-BuhCV9Ak.js";const q=()=>{const y=new Date;return new Intl.DateTimeFormat("en-CA",{timeZone:"Asia/Manila",year:"numeric",month:"2-digit",day:"2-digit"}).format(y)},ss=({open:y,onClose:b,item:r,multi:m=!1,itemsForMulti:I=[]})=>{const[w,f]=h.useState([]),[D,C]=h.useState(null),[n,g]=h.useState([]),[U,_e]=h.useState([]),[c,p]=h.useState({}),[J,M]=h.useState(""),[j,$]=h.useState(""),[v,B]=h.useState(""),{data:t,setData:x,post:z,processing:N,errors:ye}=ie({item_id:r?.id||"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:q(),disposed_by:"",notes:"",disposal_cost:"",batches:[]});h.useEffect(()=>{(async()=>{if(y){if(m){try{console.log("Loading batches for multi disposal, itemsForMulti:",I);const i=I.map(s=>s.id).filter(s=>s);if(console.log("Item IDs to fetch:",i),i.length===0){console.log("No valid item IDs found"),f([]);return}const l=await fetch(route("pharmacist.inventory.items.batches"),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({item_ids:i})});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const d=await l.json();console.log("Fetched batches:",d),f(Array.isArray(d)?d:[])}catch(i){console.error("Failed to load batches",i),f([])}x({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:q(),disposed_by:"Current User",notes:"",disposal_cost:""});return}if(r){try{const l=await(await fetch(route("pharmacist.inventory.item.batches",r.id))).json();f(Array.isArray(l)?l:[])}catch(i){console.error("Failed to load batches",i),f([])}x({item_id:r.id,batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:q(),disposed_by:"Current User",notes:"",disposal_cost:""})}}})()},[r,y,m,JSON.stringify(U)]);const K=a=>{p({}),C(a),x({...t,batch_number:a.batch_number,quantity:a.available_quantity}),g(i=>i.find(d=>d.batch_number===a.batch_number)?i.filter(d=>d.batch_number!==a.batch_number):[...i,{...a,quantity:Math.min(a.available_quantity,a.quantity??a.available_quantity)}]),M("")},W=(a,i,l)=>{g(d=>d.map(s=>(s.item_id||t.item_id)===a&&s.batch_number===i?{...s,quantity:l}:s))},Y=()=>{const a={};return n.length===0&&(a.batch_number="Please select at least one batch"),(Array.isArray(n)?n.reduce((l,d)=>l+(Number(d?.quantity)||0),0):0)<=0&&(a.quantity="Please enter a valid quantity for selected batches"),t.disposal_reason.trim()||(a.disposal_reason="Please provide a reason for disposal"),t.disposal_method||(a.disposal_method="Please select a disposal method"),t.disposal_method==="other"&&!j.trim()&&(a.custom_disposal_method="Please specify the disposal method"),t.disposal_reason==="Other"&&!v.trim()&&(a.custom_disposal_reason="Please specify the disposal reason"),t.disposal_date||(a.disposal_date="Please select a disposal date"),p(a),Object.keys(a).length===0},Z=a=>{if(a.preventDefault(),!Y())return;if(!m&&D&&t.quantity>D.available_quantity){p({quantity:`Cannot dispose more than available stock (${D.available_quantity} units)`});return}if(t.disposal_date){const s=q(),o=t.disposal_date;if(o<s){p({disposal_date:"Disposal date cannot be in the past"});return}if(o>s){p({disposal_date:"Disposal date cannot be in the future. Only today's date is allowed for disposal."});return}}const i={};n.length===0&&(i.general="Please select at least one batch to dispose");const l=[];if(n.forEach(s=>{const o=Number(s.quantity),V=Number(s.available_quantity);!s.quantity||o<=0?l.push(`${s.batch_number}: Quantity must be greater than 0`):o>V&&l.push(`${s.batch_number}: Cannot dispose more than available (${V} units)`)}),l.length>0&&(i.quantity=l.join(`
`)),t.disposal_method||(i.disposal_method="Please select a disposal method"),t.disposal_reason||(i.disposal_reason="Please select a disposal reason"),t.disposal_method==="other"&&(!j||j.trim()==="")&&(i.custom_disposal_method="Please specify the disposal method"),t.disposal_reason==="Other"&&(!v||v.trim()==="")&&(i.custom_disposal_reason="Please specify the disposal reason"),Object.keys(i).length>0){p(i);return}const d={item_id:m&&n[0]?.item_id||t.item_id,batches:n.map(s=>({batch_number:s.batch_number,quantity:Number(s.quantity)||0,item_id:s.item_id||t.item_id})),disposal_reason:t.disposal_reason==="Other"?v:t.disposal_reason,disposal_method:t.disposal_method==="other"?j:t.disposal_method,disposal_date:t.disposal_date,disposed_by:t.disposed_by,notes:t.notes,disposal_cost:t.disposal_cost};if(console.log("Payload validation:",{batchesCount:d.batches.length,batches:d.batches,totalQuantity:d.batches.reduce((s,o)=>s+o.quantity,0)}),n.length>1||m){console.log("Submitting bulk disposal with payload:",d),console.log("Selected batches:",n),E.post(route("pharmacist.inventory.dispose.bulk"),d,{onSuccess:s=>{console.log("Bulk disposal successful:",s),L("Bulk Disposal Successful","Bulk disposal completed successfully!","delete"),b(),E.visit(window.location.pathname,{method:"get"}),x({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:"",disposed_by:"",notes:"",disposal_cost:"",batches:[]}),C(null),g([]),p({}),$(""),B(""),window.location.reload()},onError:s=>{if(console.error("Bulk disposal error:",s),s&&typeof s=="object"){const o=[];s.batches&&o.push(`Batches: ${Array.isArray(s.batches)?s.batches[0]:s.batches}`),s.disposal_reason&&o.push(`Disposal reason: ${Array.isArray(s.disposal_reason)?s.disposal_reason[0]:s.disposal_reason}`),s.disposal_method&&o.push(`Disposal method: ${Array.isArray(s.disposal_method)?s.disposal_method[0]:s.disposal_method}`),s.disposal_date&&o.push(`Disposal date: ${Array.isArray(s.disposal_date)?s.disposal_date[0]:s.disposal_date}`),s.disposed_by&&o.push(`Disposed by: ${Array.isArray(s.disposed_by)?s.disposed_by[0]:s.disposed_by}`),s.disposal_cost&&o.push(`Disposal cost: ${Array.isArray(s.disposal_cost)?s.disposal_cost[0]:s.disposal_cost}`),o.length>0?_("Validation Errors",o.join(", ")):_("Bulk Disposal Failed","Please check your inputs and try again.")}else typeof s=="string"?_("Bulk Disposal Error",s):_("Bulk Disposal Failed","An unexpected error occurred. Please try again.");p(s)}});return}z(route("pharmacist.inventory.dispose"),{onSuccess:s=>{console.log("Disposal successful:",s),L("Disposal Successful","Disposal completed successfully!","delete"),b(),E.visit(window.location.pathname,{method:"get"}),x({item_id:"",batch_number:"",quantity:"",disposal_reason:"",disposal_method:"",disposal_date:"",disposed_by:"",notes:"",disposal_cost:"",batches:[]}),C(null),g([]),p({}),$(""),B(""),window.location.reload()},onError:s=>{if(console.error("Disposal error:",s),s&&typeof s=="object"){const o=[];s.item_id&&o.push(`Item: ${Array.isArray(s.item_id)?s.item_id[0]:s.item_id}`),s.batch_number&&o.push(`Batch number: ${Array.isArray(s.batch_number)?s.batch_number[0]:s.batch_number}`),s.quantity&&o.push(`Quantity: ${Array.isArray(s.quantity)?s.quantity[0]:s.quantity}`),s.disposal_reason&&o.push(`Disposal reason: ${Array.isArray(s.disposal_reason)?s.disposal_reason[0]:s.disposal_reason}`),s.disposal_method&&o.push(`Disposal method: ${Array.isArray(s.disposal_method)?s.disposal_method[0]:s.disposal_method}`),s.disposal_date&&o.push(`Disposal date: ${Array.isArray(s.disposal_date)?s.disposal_date[0]:s.disposal_date}`),s.disposed_by&&o.push(`Disposed by: ${Array.isArray(s.disposed_by)?s.disposed_by[0]:s.disposed_by}`),s.disposal_cost&&o.push(`Disposal cost: ${Array.isArray(s.disposal_cost)?s.disposal_cost[0]:s.disposal_cost}`),o.length>0?_("Validation Errors",o.join(", ")):_("Disposal Failed","Please check your inputs and try again.")}else typeof s=="string"?_("Disposal Error",s):_("Disposal Failed","An unexpected error occurred. Please try again.");p(s)}})},R=a=>a?new Date(a).toLocaleDateString():"N/A",G=a=>a?new Date(a)<new Date:!1,ee=a=>{if(!a)return!1;const i=new Date(a),d=Math.ceil((i-new Date)/(1e3*60*60*24));return d<=30&&d>0},se=a=>G(a)?{status:"expired",color:"text-red-600",bgColor:"bg-red-50",icon:e.jsx(ue,{className:"h-4 w-4"})}:ee(a)?{status:"expiring",color:"text-amber-600",bgColor:"bg-amber-50",icon:e.jsx(he,{className:"h-4 w-4"})}:{status:"valid",color:"text-green-600",bgColor:"bg-green-50",icon:e.jsx(xe,{className:"h-4 w-4"})},ae=[{value:"incineration",label:"Incineration"},{value:"landfill",label:"Landfill Disposal"},{value:"return_supplier",label:"Return to Supplier"},{value:"donation",label:"Donation (if applicable)"},{value:"other",label:"Other"}],te=[{value:"Expired",label:"Expired Product"},{value:"Damaged",label:"Damaged Product"},{value:"Recalled",label:"Product Recall"},{value:"Contaminated",label:"Contaminated Product"},{value:"Excess Stock",label:"Excess Stock"},{value:"Other",label:"Other"}];if(!r&&!m)return null;const Q=m&&r&&r.id==="bulk";return e.jsx(le,{open:y,onOpenChange:b,children:e.jsxs(oe,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(de,{children:e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5 text-red-600"}),m?"Batch Disposal - Multiple Items":`Batch Disposal - ${r?.name??""}`]})}),e.jsxs("form",{onSubmit:Z,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Item Information"}),!m&&r&&r.id!=="bulk"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Item:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Manufacturer:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.manufacturer||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"ml-2 font-medium",children:r.category?.name||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Current Stock:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[r.quantity||0," ",r.unit_type||"units"]})]})]}),(m||Q)&&e.jsx("div",{children:e.jsx("p",{className:"text-sm text-gray-600",children:"Select batches from the list below to dispose. You can select multiple batches from different items."})})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-sm font-medium",children:"Available Batches"}),e.jsxs("div",{className:"mt-2",children:[e.jsxs(k,{value:J,onValueChange:a=>{if(M(a),a&&a!==""){const i=w.find(l=>`${l.batch_number}-${l.item_id||t.item_id}`===a);i&&K(i)}},children:[e.jsx(P,{className:"w-full",children:e.jsx(F,{placeholder:"Select batches to dispose (multiple selection)"})}),e.jsx(O,{className:"max-h-60",children:(Array.isArray(w)?w:[]).filter(a=>a.batch_number&&a.batch_number!=="new_batch"&&a.batch_number!=="N/A"&&a.available_quantity>0).map((a,i)=>{const l=se(a.expiry_date),d=n.find(s=>s.batch_number===a.batch_number);return e.jsx(T,{value:`${a.batch_number}-${a.item_id||t.item_id}`,className:"cursor-pointer",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${d?"bg-red-500":"bg-gray-300"}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{className:"font-medium",children:[a.batch_number,a.item_name?` (${a.item_name})`:""]}),e.jsxs("div",{className:`flex items-center gap-1 px-2 py-1 rounded-full text-xs ${l.bgColor} ${l.color}`,children:[l.icon,l.status==="expired"?"Expired":l.status==="expiring"?"Expiring Soon Items":"Valid"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Available: ",a.available_quantity," units"]})]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-4 w-4"}),R(a.expiry_date)]}),e.jsx("div",{className:"text-xs text-gray-500",children:a.location})]})]})},`${a.item_id||t.item_id}:${a.batch_number||"NB"}:${i}`)})})]}),c.batch_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.batch_number})]})]}),n.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(u,{className:"text-sm font-medium",children:"Selected Batches - Set Quantities"}),n.map((a,i)=>e.jsxs("div",{className:"p-3 border border-red-200 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{className:"font-medium",children:[a.batch_number,a.item_name?` (${a.item_name})`:""]})]}),e.jsx(S,{type:"button",variant:"outline",size:"sm",onClick:()=>{g(l=>l.filter(d=>d.batch_number!==a.batch_number))},className:"text-red-600 hover:text-red-700",children:"Remove"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(u,{className:"text-xs",children:"Quantity to dispose"}),e.jsx(A,{type:"number",min:0,max:a.available_quantity,value:a.quantity||0,onChange:l=>W(a.item_id||t.item_id,a.batch_number,Math.min(Number(l.target.value)||0,a.available_quantity)),className:"mt-1"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Max ",a.available_quantity," units"]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsxs("div",{children:["Available: ",a.available_quantity," units"]}),e.jsx("div",{className:"text-xs text-gray-500",children:R(a.expiry_date)})]})]})]},`${a.batch_number}-${a.item_id||t.item_id}`))]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{children:"Total Quantity to Dispose"}),e.jsxs("div",{className:"mt-1 font-medium",children:[n.reduce((a,i)=>a+(Number(i.quantity)||0),0)," units"]}),c.quantity&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.quantity})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"disposal_date",children:"Disposed Date *"}),e.jsx(A,{id:"disposal_date",type:"date",value:t.disposal_date,readOnly:!0,className:"mt-1",min:new Date().toISOString().split("T")[0],max:new Date().toISOString().split("T")[0]}),c.disposal_date&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.disposal_date})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"disposal_reason",children:"Disposal Reason *"}),e.jsxs(k,{value:t.disposal_reason,onValueChange:a=>x({...t,disposal_reason:a}),children:[e.jsx(P,{className:"mt-1",children:e.jsx(F,{placeholder:"Select reason"})}),e.jsx(O,{children:te.map(a=>e.jsx(T,{value:a.value,children:a.label},a.value))})]}),c.disposal_reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.disposal_reason}),t.disposal_reason==="Other"&&e.jsxs("div",{className:"mt-2",children:[e.jsx(u,{htmlFor:"custom_disposal_reason",children:"Specify: *"}),e.jsx(A,{id:"custom_disposal_reason",type:"text",value:v,onChange:a=>B(a.target.value),placeholder:"Please specify the disposal reason",className:"mt-1",required:!0}),c.custom_disposal_reason&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.custom_disposal_reason})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"disposal_method",children:"Disposal Method *"}),e.jsxs(k,{value:t.disposal_method,onValueChange:a=>x({...t,disposal_method:a}),children:[e.jsx(P,{className:"mt-1",children:e.jsx(F,{placeholder:"Select method"})}),e.jsx(O,{children:ae.map(a=>e.jsx(T,{value:a.value,children:a.label},a.value))})]}),c.disposal_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.disposal_method}),t.disposal_method==="other"&&e.jsxs("div",{className:"mt-2",children:[e.jsx(u,{htmlFor:"custom_disposal_method",children:"Specify: *"}),e.jsx(A,{id:"custom_disposal_method",type:"text",value:j,onChange:a=>$(a.target.value),placeholder:"Please specify the disposal method",className:"mt-1",required:!0}),c.custom_disposal_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:c.custom_disposal_method})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"notes",children:"Additional Notes"}),e.jsx(ce,{id:"notes",value:t.notes,onChange:a=>x({...t,notes:a.target.value}),placeholder:"Any additional notes about the disposal...",className:"mt-1",rows:3})]}),n.length>0&&e.jsxs(pe.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-semibold text-red-900 mb-2 flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4"}),"Disposal Summary"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Total Batches:"}),e.jsx("span",{className:"ml-2 font-medium",children:n.length})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Total Quantity:"}),e.jsxs("span",{className:"ml-2 font-medium",children:[n.reduce((a,i)=>a+(Number(i?.quantity)||0),0)," units"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Reason:"}),e.jsx("span",{className:"ml-2 font-medium",children:t.disposal_reason||"Not specified"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-red-700",children:"Method:"}),e.jsx("span",{className:"ml-2 font-medium",children:t.disposal_method||"Not specified"})]})]})]}),e.jsxs(re,{children:[e.jsx(S,{type:"button",variant:"outline",onClick:b,disabled:N,children:"Cancel"}),!m&&e.jsx(S,{type:"submit",disabled:N||!D,className:"bg-red-600 hover:bg-red-700 text-white",children:N?"Disposing...":"Dispose Batch"}),(m||Q)&&e.jsx(S,{type:"submit",disabled:N||n.length===0,className:"bg-red-600 hover:bg-red-700 text-white",children:N?"Disposing...":"Dispose Selected Batches"})]})]})]})})};export{ss as default};
